<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <!-- Content Security Policy for Cordova -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self' data: gap:;
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.firebaseapp.com https://www.gstatic.com;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
        font-src 'self' https://fonts.gstatic.com data:;
        connect-src *;">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>হিলফুল ফুজুল যুব সংঘ - Begompur</title>

    
    
    <!-- jsPDF and xlsx Libraries for Downloading -->
     <!-- index.html -->
<script src="js/jspdf.umd.min.js"></script> 
<script src="js/xlsx.full.min.js"></script>

   

    <!-- PWA Manifest -->
    <link rel="manifest" href="https://najmul00723.github.io/-hilful-fuzul-begomopur-app/manifest.json">
    <meta name="theme-color" content="#111827">

    <!-- Lucide Icons JS from CDN --> 
     <!-- Third-party libraries -->
    <link href="css/tailwind.css" rel="stylesheet">
    <link href="css/fonts.css" rel="stylesheet">
    <script src="js/lucide.min.js"></script>
    
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <style>
        /* Custom Base Styles */
        body {
            font-family: 'Tiro Bangla', serif;
            background-color: #111827;
            color: #f9fafb;
            scroll-behavior: smooth;
        }
        .accent-color { color: #f59e0b; }
        .bg-accent { background-color: #f59e0b; }
        .border-accent { border-color: #f59e0b; }
        .bg-card { background-color: #1f2937; }
        .bg-card-light { background-color: #374151; }
        .text-custom-gold { color: #f59e0b; }
        .nav-tab.active {
            border-bottom: 2px solid #f59e0b;
            color: #f59e0b;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
        }
        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
        .watermark {
            position: fixed;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: -1;
            opacity: 0.09;
            pointer-events: none;
        }
        .group-badge {
            font-size: 0.9rem;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 9999px;
            color: white;
        }
        .group-badge.negative {
            border: 2px dashed #f9fafb;
        }
        .tab-content, .fund-subcontent {
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
        }
        .fund-subcontent {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            visibility: hidden;
            transform: translateY(10px);
        }
        .fund-subcontent.active-subcontent {
            max-height: 10000px;
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        button, a, .cursor-pointer {
            transition: all 0.2s ease-in-out;
        }
        button:hover, a:hover {
            transform: translateY(-1px);
            filter: brightness(1.1);
        }
        /* Pull to Refresh Styles */
        #pull-to-refresh {
    position: absolute;
    top: -50px;
    left: 0;
    right: 0;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #f59e0b;
    transition: transform 0.2s;
    z-index: 30;
    pointer-events: none;
}
#pull-to-refresh .icon {
    transition: transform 0.2s;
}
#pull-to-refresh.refreshing .icon {
    animation: spin 1s linear infinite;
}
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* মেইন কন্টেন্টের জন্য স্ক্রল স্টাইল */
main {
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    height: calc(100vh - 140px); /* হেডার এবং ফুটারের উচ্চতা বিবেচনা করে */
}
        /* স্টার রেটিং স্টাইল */
.star-btn {
    transition: all 0.2s ease-in-out;
    cursor: pointer;
}

.star-btn:hover {
    transform: scale(1.2);
}

/* ট্যাব কন্টেন্ট ট্রানজিশন */
.donor-tab-content {
    transition: opacity 0.3s ease-in-out;
}

/* রেটিং কার্ড স্টাইল */
.rating-card {
    border-left: 3px solid #f59e0b;
    position: relative;
}

.rating-card:hover {
    background-color: #374151;
    transition: background-color 0.2s ease-in-out;
}

.delete-rating-btn {
    transition: all 0.2s ease-in-out;
}

.delete-rating-btn:hover {
    transform: scale(1.1);
}

</style>
    
    
</head>
<body class="antialiased">
     <div class="hidden">
    <span class="text-green-400"></span>
    <span class="text-red-400"></span>
    <span class="text-yellow-400"></span>
    <span class="font-bold"></span>
  </div>
    <!-- Watermark Logo -->
    <div class="watermark">
        <img src="img/hilfullogofinal.png" alt="হিলফুল ফুজুল যুব সংঘ বেগমপুর লোগো" class="w-80 h-80 sm:w-96 sm:h-96 object-contain">
    </div>

    <!-- Main Container -->
    <div id="app" class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="sticky top-0 bg-card z-40 shadow-md">
            <div class="container mx-auto px-4 py-3 flex flex-col sm:flex-row sm:justify-between sm:items-center">
                <div class="flex items-center gap-3 w-full">
                    <img src="img/hilfullogofinal.png" alt="লোগো" class="h-12 w-12 rounded-full object-cover">
                    <div>
                        <h1 class="text-lg sm:text-xl md:text-2xl font-bold accent-color">হিলফুল ফুজুল যুব সংঘ বেগমপুর</h1>
                        <p class="text-xs text-gray-300">"ইসলামের আলোয় আলোকিত হয়, মানবতার সেবায় নিবেদিত হয়!"</p>
                    </div>
                </div>
                <button id="auth-button" class="bg-accent text-white text-xs px-3 py-1.5 sm:text-sm sm:px-4 sm:py-2 rounded-lg hover:bg-amber-600 self-end mt-2 sm:mt-0 sm:self-auto shadow-md hover:shadow-lg transition-all">
                    অ্যাডমিন লগইন
                </button>
            </div>
            <!-- Navigation Tabs -->
            <nav class="bg-card-light">
                <div class="container mx-auto px-2 sm:px-4 flex justify-center flex-wrap space-x-2 sm:space-x-6">
                    <button data-tab="dashboard" class="main-nav-tab nav-tab py-3 px-2 md:px-4 text-sm sm:text-base text-gray-300 hover:text-white active">ড্যাশবোর্ড</button>
                    <button data-tab="fund" class="main-nav-tab nav-tab py-3 px-2 md:px-4 text-sm sm:text-base text-gray-300 hover:text-white">তহবিল</button>
                    <button data-tab="donor" class="main-nav-tab nav-tab py-3 px-2 md:px-4 text-sm sm:text-base text-gray-300 hover:text-white">রক্তদাতা</button>
                    <button data-tab="download" class="main-nav-tab nav-tab py-3 px-2 md:px-4 text-sm sm:text-base text-gray-300 hover:text-white">ডাউনলোড</button>
                    <button data-tab="about" class="main-nav-tab nav-tab py-3 px-2 md:px-4 text-sm sm:text-base text-gray-300 hover:text-white">জানুন</button>
                    <!-- Update the admin tab to be super-admin only -->
                    <button data-tab="admin" class="main-nav-tab nav-tab py-3 px-2 md:px-4 text-sm sm:text-base text-gray-300 hover:text-white admin-only super-admin-only" style="display: none;">অ্যাডমিন</button>
                </div>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto p-4 md:p-6 flex-grow relative">
            <!-- Pull to Refresh Indicator -->
            <div id="pull-to-refresh">
                <div class="icon">
                    <i data-lucide="arrow-down"></i>
                </div>
            </div>
            <!-- Dashboard Page -->
            <div id="dashboard-page" class="tab-content">
                <!-- Call to Action Section -->
                <div class="bg-card p-6 rounded-lg shadow-lg text-center mb-6">
                    <h2 class="text-xl sm:text-2xl font-bold accent-color mb-3">ভালো কাজ থেমে না যাক, আর্থিক দাতা হিসেবে যুক্ত হন আজই!</h2>
                    <div class="flex flex-wrap justify-center items-center gap-3 mt-2">
                        <a href="https://www.facebook.com/profile.php?id=61577696172569" target="_blank" class="inline-flex items-center justify-center bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="w-5 h-5 mr-2 fill-current"><path d="M256.6 8C116.5 8 8 110.3 8 248.6c0 72.3 29.7 134.8 78.1 177.9 8.4 7.5 6.6 11.9 8.1 58.2A19.9 19.9 0 0 0 122 502.3c52.9-23.3 53.6-25.1 62.6-22.7C337.9 521.8 504 423.7 504 248.6 504 110.3 396.6 8 256.6 8zm149.2 185.1l-73 115.6a37.4 37.4 0 0 1 -53.9 9.9l-58.1-43.5a15 15 0 0 0 -18 0l-78.4 59.4c-10.5 7.9-24.2-4.6-17.1-15.7l73-115.6a37.4 37.4 0 0 1 53.9-9.9l58.1 43.5a15 15 0 0 0 18 0l78.4-59.4c10.4-8 24.1 4.5 17.1 15.6z"/></svg>
                            Messenger
                        </a>
                        <a href="https://chat.whatsapp.com/J3IH8WrfPblKbDsn9VWW1d?mode=ac_c" target="_blank" class="inline-flex items-center justify-center bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="w-5 h-5 mr-2 fill-current"><path d="M380.9 97.1C339 55.1 283.2 32 223.9 32c-122.4 0-222 99.6-222 222 0 39.1 10.2 77.3 29.6 111L0 480l117.7-30.9c32.4 17.7 68.9 27 106.1 27h.1c122.3 0 224.1-99.6 224.1-222 0-59.3-25.2-115-67.1-157zm-157 341.6c-33.2 0-65.7-8.9-94-25.7l-6.7-4-69.8 18.3L72 359.2l-4.4-7c-18.5-29.4-28.2-63.3-28.2-98.2 0-101.7 82.8-184.5 184.6-184.5 49.3 0 95.6 19.2 130.4 54.1 34.8 34.9 56.2 81.2 56.1 130.5 0 101.8-84.9 184.6-186.6 184.6zm101.2-138.2c-5.5-2.8-32.8-16.2-37.9-18-5.1-1.9-8.8-2.8-12.5 2.8-3.7 5.6-14.3 18-17.6 21.8-3.2 3.7-6.5 4.2-12 1.4-32.6-16.3-54-29.1-75.5-66-5.7-9.8 5.7-9.1 16.3-30.3 1.8-3.7 .9-6.9-.5-9.7-1.4-2.8-12.5-30.1-17.1-41.2-4.5-10.8-9.1-9.3-12.5-9.5-3.2-.2-6.9-.2-10.6-.2-3.7 0-9.7 1.4-14.8 6.9-5.1 5.6-19.4 19-19.4 46.3 0 27.3 19.9 53.7 22.6 57.4 2.8 3.7 39.1 59.7 94.8 83.8 35.2 15.2 49 16.5 66.6 13.9 10.7-1.6 32.8-13.4 37.4-26.4 4.6-13 4.6-24.1 3.2-26.4-1.3-2.5-5-3.9-10.5-6.6z"/></svg>
                                WhatsApp
                        </a>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-card p-5 rounded-lg shadow"><h3 class="text-gray-400 text-lg">মোট আয়</h3><p id="total-income" class="text-3xl font-bold accent-color">৳ ০</p></div>
                    <div class="bg-card p-5 rounded-lg shadow"><h3 class="text-gray-400 text-lg">মোট ব্যয়</h3><p id="total-expense" class="text-3xl font-bold text-red-500">৳ ০</p></div>
                    <div class="bg-card p-5 rounded-lg shadow"><h3 class="text-gray-400 text-lg">বর্তমান ব্যালেন্স</h3><p id="current-balance" class="text-3xl font-bold text-green-500">৳ ০</p></div>
                    <div class="bg-card p-5 rounded-lg shadow"><h3 class="text-gray-400 text-lg">মোট রক্তদাতা</h3><p id="total-donors" class="text-3xl font-bold">০ জন</p></div>
                </div>
                <div class="bg-card p-6 rounded-lg shadow text-center">
                    <h2 class="text-2xl font-bold mb-4">সংগঠনে অনুদান পাঠান</h2>
                    <p class="text-gray-300 mb-4">আপনার অনুদান অসহায় মানুষের মুখে হাসি ফোটাতে পারে।</p>
                    
                    <p class="text-lg font-semibold text-white mb-2">বিকাশে সেন্ড মানি করুন</p>
                    
                    <!-- QR Code Image -->
                    <div class="flex justify-center mb-4">
                        <img src="img/qr-number-160-160.png" alt="QR Code" class="w-40 h-40 rounded-lg bg-white p-1 object-contain">
                    </div>

                    <!-- bKash Number -->
                    <div class="flex justify-center items-center gap-4">
                        <p id="bkash-number-display" class="text-2xl sm:text-3xl font-bold accent-color tracking-widest">01XXXXXXXXX</p>
                        <button id="copy-bkash-btn" class="p-2 bg-card-light rounded-lg hover:bg-gray-600"><i data-lucide="copy" class="w-6 h-6"></i></button>
                    </div>

                    <!-- Admin Edit Section -->
                    <div id="edit-bkash-container" class="mt-4 hidden">
                         <input type="text" id="bkash-number-input" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-center" placeholder="নতুন বিকাশ নম্বর">
                         <button id="save-bkash-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg ml-2 hover:bg-green-700">সেভ</button>
                    </div>
                </div>
            </div>

            <!-- Fund Page -->
            <div id="fund-page" class="tab-content hidden">
                <div class="flex justify-center border-b border-gray-700 mb-6">
                    <button data-subtab="all-contributors" class="fund-subtab nav-tab py-2 px-4 sm:px-6 text-sm sm:text-base active">সকল দাতা</button>
                    <button data-subtab="zakat-fund" class="fund-subtab nav-tab py-2 px-4 sm:px-6 text-sm sm:text-base">যাকাত ফান্ড</button>
                    <button data-subtab="events" class="fund-subtab nav-tab py-2 px-4 sm:px-6 text-sm sm:text-base">ইভেন্ট</button>
                    <button data-subtab="expense" class="fund-subtab nav-tab py-2 px-4 sm:px-6 text-sm sm:text-base">ব্যয়ের খাতা</button>
                </div>
                
                <div id="all-contributors-subpage" class="fund-subcontent active-subcontent">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                        <h2 class="text-2xl font-bold">সকল আর্থিক দাতার তালিকা</h2>
                        <button id="add-contributor-btn" class="admin-only bg-accent text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-amber-600 w-full sm:w-auto"><i data-lucide="plus-circle" class="w-5 h-5"></i> নতুন দাতা</button>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                        <div class="relative w-full sm:max-w-sm">
                            <input type="text" id="contributor-search-input" class="w-full bg-card-light p-3 pl-10 rounded-lg border-2 border-transparent focus:border-accent focus:outline-none" placeholder="দাতা খুঁজুন (নাম, ঠিকানা)...">
                            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                        </div>
                        <div id="contributor-counter" class="text-right text-gray-400 font-semibold w-full sm:w-auto">মোট দাতা: ০ জন</div>
                    </div>
                    <div id="contributors-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>

                <div id="zakat-fund-subpage" class="fund-subcontent">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                        <h2 class="text-2xl font-bold">যাকাত ফান্ড দাতার তালিকা</h2>
                        <button id="add-zakat-contributor-btn" class="admin-only bg-accent text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-amber-600 w-full sm:w-auto"><i data-lucide="plus-circle" class="w-5 h-5"></i> নতুন যাকাত দাতা</button>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                        <div class="relative w-full sm:max-w-sm">
                            <input type="text" id="zakat-contributor-search-input" class="w-full bg-card-light p-3 pl-10 rounded-lg border-2 border-transparent focus:border-accent focus:outline-none" placeholder="দাতা খুঁজুন (নাম, ঠিকানা)...">
                            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                        </div>
                        <div id="zakat-contributor-counter" class="text-right text-gray-400 font-semibold w-full sm:w-auto">মোট দাতা: ০ জন</div>
                    </div>
                    <div id="zakat-contributors-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>

                <div id="events-subpage" class="fund-subcontent">
                    <div id="events-list-view">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                            <h2 class="text-2xl font-bold">সকল ইভেন্ট</h2>
                            <button id="add-event-btn" class="admin-only bg-accent text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-amber-600 w-full sm:w-auto"><i data-lucide="calendar-plus" class="w-5 h-5"></i> নতুন ইভেন্ট</button>
                        </div>
                        <div id="events-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    </div>
                    <div id="event-details-view" class="hidden"></div>
                </div>

                <div id="expense-subpage" class="fund-subcontent">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">সকল ব্যয়ের হিসাব</h2>
                        <button id="add-expense-btn" class="admin-only bg-red-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-red-700"><i data-lucide="minus-circle" class="w-5 h-5"></i> নতুন ব্যয়</button>
                    </div>
                    <div id="expenses-list-container" class="space-y-4"></div>
                </div>
            </div>

            <!-- Blood Donor Page -->
            <div id="donor-page" class="tab-content hidden">
    <!-- Updated Donor Admin Panel -->
    <div id="donor-admin-panel" class="admin-only bg-card p-4 rounded-lg mb-6" style="display: none;">
        <h3 class="text-xl font-bold mb-4 accent-color" id="donor-panel-title">
            <!-- Title will be set dynamically based on role -->
        </h3>
        <div class="grid md:grid-cols-2 gap-6">
            <div>
                <h4 class="text-lg font-semibold mb-2">রক্তদাতা ব্যবস্থাপনা</h4>
                <button id="add-blood-donor-btn" class="w-full bg-accent text-white py-2 rounded-lg flex items-center justify-center gap-2 hover:bg-amber-600">
                    <i data-lucide="user-plus" class="w-5 h-5"></i> নতুন রক্তদাতা যোগ
                </button>
            </div>
            <div id="coordinator-management-section" style="display: none;">
                <h4 class="text-lg font-semibold mb-2">সমন্বয়কারী ব্যবস্থাপনা</h4>
                <button id="manage-coordinators-btn" class="w-full bg-blue-600 text-white py-2 rounded-lg flex items-center justify-center gap-2 hover:bg-blue-700">
                    <i data-lucide="users" class="w-5 h-5"></i> সমন্বয়কারী তালিকা
                </button>
            </div>
        </div>
    </div>
                <div class="bg-card p-6 rounded-lg shadow-lg text-center mb-6">
                    <h2 class="text-xl sm:text-2xl font-bold accent-color mb-3">রক্ত দিয়ে জীবন বাঁচান, রক্তদাতা হতে তথ্য দিয়ে সহযোগিতা করুন।</h2>
                    <div class="flex flex-wrap justify-center items-center gap-3 mt-2">
                        <a href="https://www.facebook.com/profile.php?id=61577696172569" target="_blank" class="inline-flex items-center justify-center bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="w-5 h-5 mr-2 fill-current"><path d="M256.6 8C116.5 8 8 110.3 8 248.6c0 72.3 29.7 134.8 78.1 177.9 8.4 7.5 6.6 11.9 8.1 58.2A19.9 19.9 0 0 0 122 502.3c52.9-23.3 53.6-25.1 62.6-22.7C337.9 521.8 504 423.7 504 248.6 504 110.3 396.6 8 256.6 8zm149.2 185.1l-73 115.6a37.4 37.4 0 0 1 -53.9 9.9l-58.1-43.5a15 15 0 0 0 -18 0l-78.4 59.4c-10.5 7.9-24.2-4.6-17.1-15.7l73-115.6a37.4 37.4 0 0 1 53.9-9.9l58.1 43.5a15 15 0 0 0 18 0l78.4-59.4c10.4-8 24.1 4.5 17.1 15.6z"/></svg>
                            Messenger
                        </a>
                        <a href="https://chat.whatsapp.com/J3IH8WrfPblKbDsn9VWW1d?mode=ac_c" target="_blank" class="inline-flex items-center justify-center bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="w-5 h-5 mr-2 fill-current"><path d="M380.9 97.1C339 55.1 283.2 32 223.9 32c-122.4 0-222 99.6-222 222 0 39.1 10.2 77.3 29.6 111L0 480l117.7-30.9c32.4 17.7 68.9 27 106.1 27h.1c122.3 0 224.1-99.6 224.1-222 0-59.3-25.2-115-67.1-157zm-157 341.6c-33.2 0-65.7-8.9-94-25.7l-6.7-4-69.8 18.3L72 359.2l-4.4-7c-18.5-29.4-28.2-63.3-28.2-98.2 0-101.7 82.8-184.5 184.6-184.5 49.3 0 95.6 19.2 130.4 54.1 34.8 34.9 56.2 81.2 56.1 130.5 0 101.8-84.9 184.6-186.6 184.6zm101.2-138.2c-5.5-2.8-32.8-16.2-37.9-18-5.1-1.9-8.8-2.8-12.5 2.8-3.7 5.6-14.3 18-17.6 21.8-3.2 3.7-6.5 4.2-12 1.4-32.6-16.3-54-29.1-75.5-66-5.7-9.8 5.7-9.1 16.3-30.3 1.8-3.7 .9-6.9-.5-9.7-1.4-2.8-12.5-30.1-17.1-41.2-4.5-10.8-9.1-9.3-12.5-9.5-3.2-.2-6.9-.2-10.6-.2-3.7 0-9.7 1.4-14.8 6.9-5.1 5.6-19.4 19-19.4 46.3 0 27.3 19.9 53.7 22.6 57.4 2.8 3.7 39.1 59.7 94.8 83.8 35.2 15.2 49 16.5 66.6 13.9 10.7-1.6 32.8-13.4 37.4-26.4 4.6-13 4.6-24.1 3.2-26.4-1.3-2.5-5-3.9-10.5-6.6z"/></svg>
                                WhatsApp
                        </a>
                    </div>
                </div>
                <div class="bg-yellow-900/50 border border-yellow-700 text-yellow-300 p-4 rounded-lg mb-6 text-center">
                    <p class="font-bold">বিশেষ সতর্কবার্তা!</p>
                    <p>ডোনারকে সরাসরি ফোন করার পূর্বে অনুগ্রহ করে আমাদের সমন্বয়কারীর সাথে যোগাযোগ করুন।</p>
                    <button id="show-coordinators-btn" class="mt-3 bg-accent text-white px-4 py-2 rounded-lg hover:bg-amber-600">সমন্বয়কারীদের তালিকা দেখুন</button>
                </div>
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <div class="relative w-full sm:max-w-sm">
                        <input type="text" id="donor-search-input" class="w-full bg-card-light p-3 pl-10 rounded-lg border-2 border-transparent focus:border-accent focus:outline-none" placeholder="রক্তদাতা খুঁজুন (নাম, গ্রুপ, ঠিকানা)...">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                    </div>
                    <div id="blood-donor-counter" class="text-right text-gray-400 font-semibold w-full sm:w-auto">মোট রক্তদাতা: ০ জন</div>
                </div>
                <div id="blood-donors-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
            </div>

            <!-- Download Page -->
            <div id="download-page" class="tab-content hidden">
                <div class="bg-card p-6 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold accent-color mb-4">মাসিক রিপোর্ট ডাউনলোড</h2>
                    <p class="text-gray-400 mb-6">নির্দিষ্ট মাস এবং বছরের আয়-ব্যয়ের হিসাব ডাউনলোড করুন।</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="report-month" class="block mb-2 text-sm font-medium text-gray-300">মাস নির্বাচন করুন</label>
                            <select id="report-month" class="bg-card-light border border-gray-600 text-white text-sm rounded-lg focus:ring-accent focus:border-accent block w-full p-2.5"></select>
                        </div>
                        <div>
                            <label for="report-year" class="block mb-2 text-sm font-medium text-gray-300">বছর নির্বাচন করুন</label>
                            <select id="report-year" class="bg-card-light border border-gray-600 text-white text-sm rounded-lg focus:ring-accent focus:border-accent block w-full p-2.5"></select>
                        </div>
                    </div>
                    <div class="flex flex-wrap justify-center items-center gap-3 mt-4">
                        <button id="download-txt-btn" class="inline-flex items-center justify-center bg-gray-600 text-white px-5 py-2.5 rounded-lg hover:bg-gray-700 transition-colors">
                            <i data-lucide="file-text" class="w-5 h-5 mr-2"></i> TXT ডাউনলোড
                        </button>
                        <button id="download-xlsx-btn" class="inline-flex items-center justify-center bg-green-600 text-white px-5 py-2.5 rounded-lg hover:bg-green-700 transition-colors">
                           <i data-lucide="file-spreadsheet" class="w-5 h-5 mr-2"></i> Excel ডাউনলোড
                        </button>
                    </div>
                </div>
            </div>
            
            
            <!-- About Page -->
<div id="about-page" class="tab-content hidden">
    <div class="bg-card p-6 rounded-lg shadow-lg text-gray-300 leading-relaxed">
        <h2 class="text-3xl font-bold accent-color mb-4 text-center">আমাদের সম্পর্কে</h2>
        <p class="text-center italic mb-6">"ইসলামের আলোয় আলোকিত হয়, মানবতার সেবায় নিবেদিত হয়!"</p>
        
        <p class="mb-4">
            এই মহান মূলমন্ত্রকে হৃদয়ে ধারণ করে পথচলা শুরু করেছে <strong class="accent-color">"হিলফুল ফুজুল যুব সংঘ বেগমপুর"</strong>। এটি একটি সম্পূর্ণ অরাজনৈতিক, স্বেচ্ছাসেবী ও ইসলামভিত্তিক যুব সংগঠন, যা ইতিহাসের সেই বিখ্যাত "হিলফুল ফুজুল" চুক্তির আদর্শে অনুপ্রাণিত, যেখানে মজলুমের পাশে দাঁড়ানো এবং সমাজে ন্যায়বিচার প্রতিষ্ঠার শপথ নেওয়া হয়েছিল।
        </p>
        <p class="mb-6">
            আমাদের মূল লক্ষ্য দুটি—একদিকে ইসলামের বিশুদ্ধ ও শান্তিপূর্ণ বাণী সমাজের প্রতিটি মানুষের কাছে পৌঁছে দেওয়া, অন্যদিকে সেই শিক্ষার আলোকে আর্তমানবতার সেবায় নিজেদের উৎসর্গ করা। আমরা বিশ্বাস করি, ইসলাম ও মানবতা পরস্পর পরিপূরক। আল্লাহর সন্তুষ্টির জন্য সৃষ্টির সেবা করাই আমাদের ব্রত।
        </p>

        <h3 class="text-2xl font-bold accent-color mb-3 border-b-2 border-accent/50 pb-2">আমাদের লক্ষ্য ও উদ্দেশ্য</h3>
        <ul class="space-y-3 list-inside mb-6">
            <li>✅ <strong class="font-semibold">ইসলামী দাওয়াত:</strong> কুরআন ও সহিহ সুন্নাহর আলোকে ইসলামের সঠিক জ্ঞান সবার কাছে পৌঁছে দেওয়া এবং ঈমান, আমল ও আখলাক গঠনে সহায়তা করা।</li>
            <li>✅ <strong class="font-semibold">সামাজিক সচেতনতা:</strong> সমাজে প্রচলিত সকল প্রকার কুসংস্কার, অন্যায় ও অসামাজিক কার্যকলাপের বিরুদ্ধে মানুষকে সচেতন করা।</li>
            <li>✅ <strong class="font-semibold">মানবসেবা:</strong> অসুস্থ ও বিপদগ্রস্তদের জন্য রক্তদান, দরিদ্র ও অসহায়দের জন্য আর্থিক সহায়তা এবং ফিতরা ও যাকাত ফান্ড গঠন করে তা সঠিকভাবে বিতরণ করা।</li>
            <li>✅ <strong class="font-semibold">জ্ঞানভিত্তিক সমাজ:</strong> তরুণদের জন্য নিয়মিত শিক্ষামূলক হালাকা, বৈঠক ও কর্মশালার আয়োজন করা।</li>
            <li>✅ <strong class="font-semibold">স্বচ্ছতা ও জবাবদিহিতা:</strong> সংগঠনের নিজস্ব তহবিলের প্রতিটি পয়সার স্বচ্ছতা নিশ্চিত করা এবং সকল আয়-ব্যয়ের হিসাব জনসম্মুখে প্রকাশ করা।</li>
        </ul>

        <!-- Updated Management Committee Section -->
        <div id="management-committee-container">
            <!-- Management committee content will be loaded here dynamically -->
        </div>

        <h3 class="text-2xl font-bold accent-color mb-3 border-b-2 border-accent/50 pb-2">আমাদের সাথে যোগ দিন</h3>
        <p class="mb-4">
            আপনি যদি একজন সৎ, নিষ্ঠাবান ও ইসলামিক মূল্যবোধে বিশ্বাসী হন এবং আল্লাহর সন্তুষ্টির জন্য সমাজের কল্যাণে কাজ করতে চান, তবে আমাদের এই সংগঠনে আপনাকে স্বাগতম। আমাদের কোনো রাজনৈতিক সংশ্লিষ্টতা নেই, এবং আমাদের সকল কার্যক্রম শুধুমাত্র স্বেচ্ছাশ্রমের ভিত্তিতে পরিচালিত হয়।
        </p>
        <p class="text-center text-lg italic accent-color mt-6">
            "দাওয়াত ও দয়ার মাধ্যমে সমাজ পরিবর্তনে এগিয়ে আসি।"
        </p>
        <p class="text-center mt-2">
            আপনিও হোন এই মহৎ কাফেলার অংশীদার। আল্লাহর সন্তুষ্টি অর্জনের পথে একসাথে চলুন।
        </p>
    </div>
</div>


            <!-- Admin Page -->
            <div id="admin-page" class="tab-content hidden">
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                <!-- User Management Card -->
        <div class="bg-card p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold accent-color mb-4">ব্যবহারকারী ব্যবস্থাপনা</h2>
            <p class="text-gray-400 mb-6">নতুন এডমিন বা সমন্বয়কারী যোগ করুন।</p>
            
            <form id="add-user-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <input type="email" id="new-user-email" placeholder="ইমেইল" class="bg-card-light p-3 rounded-lg" required>
                <input type="password" id="new-user-password" placeholder="পাসওয়ার্ড" class="bg-card-light p-3 rounded-lg" required>
                <select id="new-user-role" class="bg-card-light p-3 rounded-lg">
                    <option value="superadmin">সুপার এডমিন</option>
                    <option value="addonly_admin">শুধু যোগ করতে পারবে</option>
                    <option value="coordinator">সমন্বয়কারী</option>
                </select>
                <button type="submit" class="bg-accent text-white py-3 rounded-lg hover:bg-amber-600 transition-colors">
                    ব্যবহারকারী যোগ করুন
                </button>
            </form>
            
            <div id="users-list" class="mt-4">
                <!-- ইউজারদের লিস্ট এখানে দেখাবে -->
            </div>
        </div>

                    <!-- Export Card -->
                    <div class="bg-card p-6 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-bold accent-color mb-4">ডেটা এক্সপোর্ট</h2>
                        <p class="text-gray-400 mb-6">সম্পূর্ণ অ্যাপ্লিকেশনের ডেটা একটি JSON ফাইলে ডাউনলোড করুন। এটি একটি ব্যাকআপ হিসেবে কাজ করবে।</p>
                        <button id="export-data-btn" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="download-cloud" class="w-5 h-5"></i> সকল ডেটা এক্সপোর্ট করুন
                        </button>
                    </div>
                    <!-- Import Card -->
                    <div class="bg-card p-6 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-bold accent-color mb-4">ডেটা ইমপোর্ট</h2>
                        <p class="text-gray-400 mb-6">JSON ব্যাকআপ ফাইল থেকে ডেটা ইমপোর্ট করুন। <strong class="text-red-500">সতর্কতা: এটি বর্তমান ডেটা মুছে নতুন ডেটা যোগ করবে।</strong></p>
                        <input type="file" id="import-file-input" class="hidden" accept=".json">
                        <button id="import-data-btn" class="w-full bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="upload-cloud" class="w-5 h-5"></i> ফাইল ইমপোর্ট করুন
                        </button>
                    </div>
                </div>
            </div>

        </main>
        
        <!-- Footer -->
        <footer class="w-full text-center py-4 bg-card mt-auto">
            <p class="text-gray-400 text-sm">
                &copy; ২০২৫ <span class="font-semibold">হিলফুল ফুজুল যুব সংঘ বেগমপুর</span> | App Created with <span class="font-semibold text-custom-gold">Najmul Hasan Bin Jalal Uddin</span>
            </p>
        </footer>
    </div>

    <!-- Modals Container -->
    <div id="modals-container"></div>
    
    <!-- Floating Back Button -->
    <button id="back-button" class="sm:hidden hidden fixed bottom-5 left-1/2 -translate-x-1/2 z-40 bg-white/20 backdrop-blur-sm text-white px-4 py-2 rounded-full flex items-center gap-2 shadow-lg">
        <i data-lucide="arrow-left" class="w-5 h-5"></i>
        ফিরে যান
    </button>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50"></div>
    
    <!-- Cordova Script for Device Ready -->
    <script src="cordova.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyAmRU9gvsLbFvg83tG61uEC0Sl_sU0o4SI",
            authDomain: "hilful-fuzul-begomopur-app.firebaseapp.com",
            projectId: "hilful-fuzul-begomopur-app",
            storageBucket: "hilful-fuzul-begomopur-app.appspot.com",
            messagingSenderId: "138687254194",
            appId: "1:138687254194:web:a0dcd54f0d9104029d83ab"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged,createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, query, where, writeBatch, Timestamp, orderBy,enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

    // অফলাইন ডেটা চালু করা হচ্ছে - এই কোড যোগ করুন
enableIndexedDbPersistence(db).catch((err) => {
    if (err.code == 'failed-precondition') {
        console.warn('Firebase persistence failed: multiple tabs open.');
    } else if (err.code == 'unimplemented') {
        console.warn('Firebase persistence is not available in this browser.');
    }
});
        
        let isAdmin = false;
        let allBloodDonors = [];
        let allContributors = [];
        let allZakatContributors = [];
        let allEvents = [];
        let allExpenses = [];
        let allCoordinators = [];
        let detailedExpenses = [];
        let currentEventDonors = [];

        // --- LOCAL STORAGE UTILS (NEW) ---
        const LS_PREFIX = 'hilfulFuzul_';
const saveToLocalStorage = (key, data) => {
    try {
        const serializedData = JSON.stringify(data, (k, v) => {
            if (v && v.hasOwnProperty('seconds') && v.hasOwnProperty('nanoseconds')) {
                return { _type: 'timestamp', value: new Date(v.seconds * 1000).toISOString() };
            }
            return v;
        });
        localStorage.setItem(LS_PREFIX + key, serializedData);
    } catch (e) {
        console.error("Error saving to localStorage", key, e);
        showToast('অফলাইন ডেটা সংরক্ষণ করা সম্ভব হচ্ছে না।', true);
    }
};

const loadFromLocalStorage = (key) => {
    try {
        const data = localStorage.getItem(LS_PREFIX + key);
        if (!data) return null;
        return JSON.parse(data, (k, v) => {
            if (v && v._type === 'timestamp') {
                return Timestamp.fromDate(new Date(v.value));
            }
            return v;
        });
    } catch (e) {
        console.error("Error loading from localStorage", key, e);
        return null;
    }
};


        // --- UTILS ---
        const showToast = (message, isError = false) => {
            const toast = document.getElementById('toast');
            if(!toast) return;
            toast.textContent = message;
            toast.className = `fixed bottom-5 right-5 text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 z-50 ${isError ? 'bg-red-600' : 'bg-green-600'}`;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        };
        
        const formatCurrency = (amount) => `৳ ${new Intl.NumberFormat('bn-BD').format(amount || 0)}`;
        const formatDate = (timestamp) => timestamp ? new Date(timestamp.seconds * 1000).toLocaleDateString('bn-BD', { day: 'numeric', month: 'long', year: 'numeric' }) : 'N/A';
        const dateToInputFormat = (date) => date ? new Date(date.seconds * 1000).toISOString().split('T')[0] : '';

        // নতুন আপডেটেড কোড
const createModal = (title, content, footer) => {
    const modalContainer = document.getElementById('modals-container');
    if (!modalContainer) return null;
    
    // Close any existing modal first - এখানে নতুন লাইন যোগ করুন
    closeModal();
    
    modalContainer.innerHTML = `<div class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4"><div class="bg-card w-full max-w-lg p-6 rounded-lg shadow-xl relative flex flex-col"><h2 class="text-2xl font-bold mb-4 accent-color flex-shrink-0">${title}</h2><div class="modal-body text-gray-300 pr-2">${content}</div><div class="modal-footer mt-6 flex justify-end gap-3 flex-shrink-0">${footer || ''}</div><button class="modal-close-btn absolute top-4 right-4 text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-5"></i></button></div></div>`;
    lucide.createIcons();
    
    // Save modal state - এই নতুন ২ লাইন যোগ করুন
    currentState.openModal = title;
    saveCurrentState();
    
    return modalContainer.querySelector('.modal-backdrop');
};

const closeModal = () => {
    document.querySelectorAll('.modal-backdrop').forEach(m => m.remove());
    
    // Clear modal state - এই নতুন ২ লাইন যোগ করুন
    currentState.openModal = null;
    saveCurrentState();
};

        const showConfirmModal = (title, message, onConfirm) => {
            // Cordova-specific dialog
            if (navigator.notification) {
                navigator.notification.confirm(
                    message,
                    (buttonIndex) => {
                        if (buttonIndex === 1) { // Assuming 'OK' is the first button
                            onConfirm();
                        }
                    },
                    title,
                    ['নিশ্চিত করুন', 'বাতিল'] // Button labels
                );
            } else { // Browser fallback
                const content = `<p>${message}</p>`;
                const footer = `<button id="confirm-cancel" class="bg-gray-600 text-white px-6 py-2 rounded-lg">বাতিল</button><button id="confirm-ok" class="bg-red-600 text-white px-6 py-2 rounded-lg">নিশ্চিত করুন</button>`;
                createModal(title, content, footer);
                document.getElementById('confirm-ok').addEventListener('click', () => {
                    onConfirm();
                    closeModal();
                });
                document.getElementById('confirm-cancel').addEventListener('click', closeModal);
            }
        };
        
        window.closeModal = closeModal;

        // --- AUTHENTICATION & CORE APP SETUP ---
        // Update the Firebase initialization section
let userRole = null;
let isSuperAdmin = false;
let isAddOnlyAdmin = false;
let isCoordinator = false;

// --- AUTHENTICATION & CORE APP SETUP ---
const initializeAppLogic = () => {
    setupEventListeners();
    
    // Load current state first
    loadCurrentState();
    
    // Firebase Authentication State Observer
    onAuthStateChanged(auth, async user => {
        if (user) {
            // Fetch user role from Firestore
            try {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    userRole = userDoc.data().role;
                    isSuperAdmin = userRole === 'superadmin';
                    isAddOnlyAdmin = userRole === 'addonly_admin';
                    isCoordinator = userRole === 'coordinator';
                } else {
                    userRole = null;
                    isSuperAdmin = false;
                    isAddOnlyAdmin = false;
                    isCoordinator = false;
                }
            } catch (error) {
                console.error("Error fetching user role:", error);
                userRole = null;
                isSuperAdmin = false;
                isAddOnlyAdmin = false;
                isCoordinator = false;
            }
            
            if (isSuperAdmin) {
                loadUsers();
            }
            
        } else {
            userRole = null;
            isSuperAdmin = false;
            isAddOnlyAdmin = false;
            isCoordinator = false;
        }
        
        updateUIVisibility();
        
        const authButton = document.getElementById('auth-button');
        if (user) {
            authButton.textContent = 'লগআউট';
            authButton.onclick = () => signOut(auth);
        } else {
            authButton.textContent = 'অ্যাডমিন লগইন';
            authButton.onclick = showLoginModal;
        }
        
        // Load all app data and restore UI state - OFFLINE SUPPORT
        loadAllData();
        
        // Restore UI state after a short delay to ensure DOM is ready
        setTimeout(() => {
            restoreUIState();
        }, 300);
    });
    
    populateDateFilters();
};

const updateUIVisibility = () => {
    // General admin visibility
    document.querySelectorAll('.admin-only').forEach(el => {
        if (el.classList.contains('super-admin-only')) {
            el.style.display = isSuperAdmin ? '' : 'none';
        } else {
            // Show admin features for superadmin, addonly_admin, and coordinator
            el.style.display = (isSuperAdmin || isAddOnlyAdmin || isCoordinator) ? '' : 'none';
        }
    });
    
    // Fund Page Restrictions for Coordinator
    if (isCoordinator) {
        // Fund page-এ coordinator এর জন্য সকল এডিট/ডিলেট বাটন লুকানো
        document.querySelectorAll('#fund-page .edit-only, #fund-page .delete-only').forEach(el => {
            el.style.display = 'none';
        });
        
        // Fund page-এ coordinator এর জন্য এড বাটনও লুকানো (যদি থাকে)
        document.querySelectorAll('#fund-page .admin-only').forEach(el => {
            if (el.id === 'add-contributor-btn' || 
                el.id === 'add-zakat-contributor-btn' || 
                el.id === 'add-event-btn' || 
                el.id === 'add-expense-btn') {
                el.style.display = 'none';
            }
        });
    }
    
    // Edit buttons - for superadmin and coordinator only, but coordinator cannot edit in fund page
    document.querySelectorAll('.edit-only').forEach(el => {
        if (isCoordinator && el.closest('#fund-page')) {
            // Coordinator cannot edit in fund page
            el.style.display = 'none';
        } else {
            el.style.display = (isSuperAdmin || isCoordinator) ? '' : 'none';
        }
    });
    
    // Delete buttons - for superadmin and coordinator only, but coordinator cannot delete in fund page
    document.querySelectorAll('.delete-only').forEach(el => {
        if (isCoordinator && el.closest('#fund-page')) {
            // Coordinator cannot delete in fund page
            el.style.display = 'none';
        } else {
            el.style.display = (isSuperAdmin || isCoordinator) ? '' : 'none';
        }
    });
    
    // Admin tab only for super admin
    const adminTab = document.querySelector('[data-tab="admin"]');
    if (adminTab) {
        adminTab.style.display = isSuperAdmin ? '' : 'none';
    }
    
    // Settings edit only for super admin
    const editBikashContainer = document.getElementById('edit-bkash-container');
    if(editBikashContainer) {
        editBikashContainer.style.display = isSuperAdmin ? 'block' : 'none';
    }
    
    // Update donor page specific visibility
    updateDonorPageVisibility();

    // রেটিং ডিলেট বাটন শুধুমাত্র অ্যাডমিনদের জন্য দেখান
    document.querySelectorAll('.delete-rating-btn').forEach(btn => {
        if (btn.closest('.admin-only')) {
            btn.style.display = (isSuperAdmin || isCoordinator) ? '' : 'none';
        }
    });
    
    // Hide edit/delete buttons for addonly_admin everywhere (they can only add)
    if (isAddOnlyAdmin) {
        document.querySelectorAll('.edit-contributor-btn, .delete-contributor-btn, .edit-event-btn, .delete-event-btn, .delete-expense-btn, .edit-donation-btn, .delete-donation-btn, .edit-expense-detail-btn, .delete-expense-detail-btn, .edit-event-donation-btn, .delete-event-donation-btn').forEach(btn => {
            btn.style.display = 'none';
        });
    }
};
        const showLoginModal = () => {
            const content = `<form id="login-form"><div class="mb-4"><label for="email" class="block mb-2">ইমেইল</label><input type="email" id="email" class="w-full bg-card-light p-3 rounded-lg border-2 border-transparent focus:border-accent focus:outline-none" required></div><div class="mb-6"><label for="password" class="block mb-2">পাসওয়ার্ড</label><input type="password" id="password" class="w-full bg-card-light p-3 rounded-lg border-2 border-transparent focus:border-accent focus:outline-none" required></div><button type="submit" class="w-full bg-accent text-white py-3 rounded-lg hover:bg-amber-600 transition-colors">লগইন</button></form>`;
            createModal('অ্যাডমিন লগইন', content, '');
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    await signInWithEmailAndPassword(auth, e.target.email.value, e.target.password.value);
                    closeModal();
                    showToast('লগইন সফল হয়েছে!');
                } catch (error) {
                    showToast('লগইন ব্যর্থ হয়েছে।', true);
                    console.error("Login Error:", error);
                }
            });
        };

        // User management functions
const loadUsers = async () => {
    if (!isSuperAdmin) return;
    
    try {
        const usersSnapshot = await getDocs(collection(db, "users"));
        const usersList = document.getElementById('users-list');
        if (!usersList) return;
        
        usersList.innerHTML = '';
        
        usersSnapshot.forEach((doc) => {
            const user = { id: doc.id, ...doc.data() };
            const userCard = document.createElement('div');
            userCard.className = 'bg-card-light p-4 rounded-lg mb-2 flex justify-between items-center';
            userCard.innerHTML = `
                <div>
                    <p class="font-bold">${user.email}</p>
                    <p class="text-sm text-gray-400">ভূমিকা: ${getRoleName(user.role)}</p>
                </div>
                <button class="delete-user-btn bg-red-600 text-white px-3 py-1 rounded-lg text-sm" data-id="${user.id}">
                    মুছুন
                </button>
            `;
            usersList.appendChild(userCard);
        });
        
        // অন্যান্য রোলের ইউজার তৈরি করার ফাংশন
const createUserWithRole = async (email, password, role) => {
    try {
        // Firebase Authentication-এ নতুন ইউজার তৈরি করুন
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        // Firestore-এ ইউজারের রোল সেভ করুন
        await setDoc(doc(db, "users", user.uid), {
            email: email,
            role: role, // 'superadmin', 'addonly_admin', বা 'coordinator'
            createdAt: Timestamp.now()
        });
        
        console.log(`${role} রোলের ইউজার সফলভাবে তৈরি হয়েছে!`);
        return user;
    } catch (error) {
        console.error('ইউজার তৈরি করতে সমস্যা:', error);
        throw error;
    }
};

       // Delete বাটনে ইভেন্ট লিসেনার যোগ করুন
        document.querySelectorAll('.delete-user-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const userId = e.target.dataset.id;
                deleteUser(userId);
            });
        });
    } catch (error) {
        console.error("Error loading users:", error);
    }
};

// রোলের নাম বাংলায় দেখানোর ফাংশন
const getRoleName = (role) => {
    const roleNames = {
        'superadmin': 'সুপার এডমিন',
        'addonly_admin': 'যোগ করতে পারবে',
        'coordinator': 'সমন্বয়কারী'
    };
    return roleNames[role] || role;
};

// ইউজার ডিলিট করার ফাংশন
const deleteUser = (userId) => {
    showConfirmModal('নিশ্চিতকরণ', 'আপনি কি এই ব্যবহারকারীকে মুছে ফেলতে চান?', async () => {
        try {
            await deleteDoc(doc(db, "users", userId));
            showToast('ব্যবহারকারী মুছে ফেলা হয়েছে');
            loadUsers();
        } catch (error) {
            showToast('ব্যবহারকারী মুছতে সমস্যা হয়েছে', true);
            console.error("Error deleting user:", error);
        }
    });
};

// Add user form handler
document.getElementById('add-user-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const email = document.getElementById('new-user-email').value;
    const password = document.getElementById('new-user-password').value;
    const role = document.getElementById('new-user-role').value;
    
    try {
        // Create user in Firebase Auth
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        // Add user role to Firestore
        await setDoc(doc(db, "users", user.uid), {
            email: email,
            role: role,
            createdAt: Timestamp.now()
        });
        
        showToast('ব্যবহারকারী সফলভাবে যোগ হয়েছে');
        document.getElementById('add-user-form').reset();
        loadUsers();
    } catch (error) {
        showToast('ব্যবহারকারী যোগ করতে সমস্যা হয়েছে', true);
        console.error("Error adding user:", error);
    }
});

        // --- DATA LOADING & RENDERING (MODIFIED FOR OFFLINE) ---
        // loadAllData ফাংশন আপডেট করুন
const loadAllData = (isRefresh = false) => {
    if (!isRefresh) {
        // Load from cache first
        loadContributors(true);
        loadZakatContributors(true);
        loadExpenses(true);
        loadBloodDonors(true);
        loadBikashNumber(true);
        loadEvents(true);
        loadCoordinators(true);
        loadManagementCommittee(true);
        calculateAndUpdateTotals();
    }
    
    // Then set up listeners for real-time updates
    if (window.snapshotListeners) {
        window.snapshotListeners.forEach(unsubscribe => unsubscribe());
    }
    
    window.snapshotListeners = [
        loadContributors(),
        loadZakatContributors(),
        loadExpenses(),
        loadBloodDonors(),
        loadBikashNumber(),
        loadEvents(),
        loadCoordinators(),
        loadManagementCommittee()
    ].filter(Boolean);
};

// loadBikashNumber ফাংশন আপডেট করুন
const loadBikashNumber = (fromCacheOnly = false) => {
    const cachedSettings = loadFromLocalStorage('settings');
    if (cachedSettings && cachedSettings.main) {
        const bkashDisplay = document.getElementById('bkash-number-display');
        const bkashInput = document.getElementById('bkash-number-input');
        if (bkashDisplay && bkashInput) {
            bkashDisplay.textContent = cachedSettings.main.bkashNumber;
            bkashInput.value = cachedSettings.main.bkashNumber;
        }
    }
    if(fromCacheOnly) return;

    return onSnapshot(doc(db, "settings", "main"), (doc) => {
        const data = doc.data();
        const bkashDisplay = document.getElementById('bkash-number-display');
        const bkashInput = document.getElementById('bkash-number-input');
        if (data && data.bkashNumber && bkashDisplay && bkashInput) {
            bkashDisplay.textContent = data.bkashNumber;
            bkashInput.value = data.bkashNumber;
            saveToLocalStorage('settings', { main: data });
        }
    }, (error) => console.error("Error fetching settings:", error.message));
};

// অন্যান্য load ফাংশনগুলিও একইভাবে আপডেট করুন
// loadContributors, loadZakatContributors, loadExpenses, loadBloodDonors, loadEvents, loadCoordinators, loadManagementCommittee

        const calculateAndUpdateTotals = () => {
            const totalIncomeEl = document.getElementById('total-income');
            const totalExpenseEl = document.getElementById('total-expense');
            const currentBalanceEl = document.getElementById('current-balance');
            const totalDonorsEl = document.getElementById('total-donors');

            let totalIncome = 0;
            let totalExpense = 0;

            allExpenses.forEach(expense => { totalExpense += expense.amount; });
            [...allContributors, ...allZakatContributors].forEach(c => {
                totalIncome += c.totalDonation || 0;
            });
            allEvents.forEach(event => {
                totalIncome += event.totalDonation || 0;
            });
            
            if(totalDonorsEl) totalDonorsEl.textContent = `${new Intl.NumberFormat('bn-BD').format(allBloodDonors.length)} জন`;
            if (totalIncomeEl) totalIncomeEl.textContent = formatCurrency(totalIncome);
            if (totalExpenseEl) totalExpenseEl.textContent = formatCurrency(totalExpense);
            if (currentBalanceEl) currentBalanceEl.textContent = formatCurrency(totalIncome - totalExpense);
        };

        const renderContributorsGeneric = (contributors, listElId, counterElId, detailsModalFn, isZakat = false) => {
    const listEl = document.getElementById(listElId);
    const counterEl = document.getElementById(counterElId);
    if (!listEl || !counterEl) return;

    counterEl.textContent = `মোট দাতা: ${new Intl.NumberFormat('bn-BD').format(contributors.length)} জন`;

    if (contributors.length === 0) {
        listEl.innerHTML = `<p class="col-span-full text-center text-gray-400">কোনো দাতার তথ্য পাওয়া যায়নি।</p>`;
        return;
    }

    // Coordinator এর জন্য Fund page-এ বাটন লুকানো
    if (isCoordinator) {
        card.querySelectorAll('.admin-actions').forEach(action => {
            action.style.display = 'none';
        });
    }

    listEl.innerHTML = '';
    contributors.forEach(contributor => {
        const card = document.createElement('div');
        card.className = 'bg-card p-4 rounded-lg shadow hover:shadow-lg hover:border-accent border border-transparent transition-all flex flex-col justify-between';
        
        const mainContent = document.createElement('div');
        mainContent.className = 'cursor-pointer contributor-details-link';
        mainContent.dataset.id = contributor.id;
        mainContent.dataset.isZakat = isZakat;
        mainContent.innerHTML = `
            <h3 class="text-xl font-bold accent-color">${contributor.name}</h3>
            <p class="text-gray-400">${contributor.address || ''}</p>
        `;
        
        const footerContent = document.createElement('div');
        footerContent.className = 'flex justify-between items-center mt-3 pt-3 border-t border-gray-600/50';
        footerContent.innerHTML = `
            <p class="text-lg font-semibold">মোট অনুদান: ${formatCurrency(contributor.totalDonation)}</p>
            <div class="admin-actions flex items-center gap-2" style="display: none;">
                <button class="edit-contributor-btn edit-only text-blue-400 hover:text-blue-300 p-1" data-id="${contributor.id}" data-is-zakat="${isZakat}" style="display: none;">
                    <i data-lucide="edit" class="w-5 h-5"></i>
                </button>
                <button class="delete-contributor-btn delete-only text-red-500 hover:text-red-400 p-1" data-id="${contributor.id}" data-is-zakat="${isZakat}" style="display: none;">
                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                </button>
            </div>
        `;
        
        card.appendChild(mainContent);
        card.appendChild(footerContent);
        listEl.appendChild(card);
    });
    lucide.createIcons();
    updateUIVisibility();
};

        const renderContributors = (contributors) => renderContributorsGeneric(contributors, 'contributors-list', 'contributor-counter', showContributorDetailsModal, false);
        const renderZakatContributors = (contributors) => renderContributorsGeneric(contributors, 'zakat-contributors-list', 'zakat-contributor-counter', showZakatContributorDetailsModal, true);

        const loadContributors = (fromCacheOnly = false) => {
    const cachedData = loadFromLocalStorage('contributors');
    if (cachedData) {
        allContributors = cachedData;
        renderContributors(allContributors);
        calculateAndUpdateTotals();
    }
    if(fromCacheOnly) return;

    const q = query(collection(db, "contributors"), orderBy("createdAt", "desc"));
    return onSnapshot(q, async (snapshot) => {
        const contributorsWithData = await Promise.all(snapshot.docs.map(async (doc) => {
            const contributor = { id: doc.id, ...doc.data() };
            const donationsSnapshot = await getDocs(collection(db, `contributors/${contributor.id}/donations`));
            contributor.donations = donationsSnapshot.docs.map(d => ({id: d.id, ...d.data()}));
            contributor.totalDonation = contributor.donations.reduce((sum, d) => sum + d.amount, 0);
            return contributor;
        }));
        allContributors = contributorsWithData;
        renderContributors(allContributors);
        saveToLocalStorage('contributors', allContributors);
        calculateAndUpdateTotals();
    }, (error) => console.error("Error loading contributors list:", error.message));
};

const loadZakatContributors = (fromCacheOnly = false) => {
    const cachedData = loadFromLocalStorage('zakat_contributors');
    if (cachedData) {
        allZakatContributors = cachedData;
        renderZakatContributors(allZakatContributors);
        calculateAndUpdateTotals();
    }
    if(fromCacheOnly) return;

    const q = query(collection(db, "zakat_contributors"), orderBy("createdAt", "desc"));
    return onSnapshot(q, async (snapshot) => {
        const contributorsWithData = await Promise.all(snapshot.docs.map(async (doc) => {
            const contributor = { id: doc.id, ...doc.data() };
            const donationsSnapshot = await getDocs(collection(db, `zakat_contributors/${contributor.id}/donations`));
            contributor.donations = donationsSnapshot.docs.map(d => ({id: d.id, ...d.data()}));
            contributor.totalDonation = contributor.donations.reduce((sum, d) => sum + d.amount, 0);
            return contributor;
        }));
        allZakatContributors = contributorsWithData;
        renderZakatContributors(allZakatContributors);
        saveToLocalStorage('zakat_contributors', allZakatContributors);
        calculateAndUpdateTotals();
    }, (error) => console.error("Error loading Zakat contributors list:", error.message));
};


        const renderExpenses = (expenses) => {
            const expenseContainer = document.getElementById('expenses-list-container');
            if(!expenseContainer) return;
            if (expenses.length === 0) { 
                expenseContainer.innerHTML = `<p class="text-center p-4 text-gray-400">কোনো ব্যয়ের হিসাব পাওয়া যায়নি।</p>`; 
                return; 
            }

             // Coordinator এর জন্য Fund page-এ বাটন লুকানো
    if (isCoordinator) {
        card.querySelectorAll('.admin-only').forEach(action => {
            action.style.display = 'none';
        });
    }

            expenseContainer.innerHTML = '';
            expenses.forEach(expense => {
                const card = document.createElement('div');
                card.className = 'bg-card-light p-4 rounded-lg shadow-md hover:shadow-lg hover:border-accent border border-transparent transition-all cursor-pointer view-expense-details-btn';
                card.dataset.id = expense.id;
                
                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex-grow pr-4">
                            <p class="font-bold text-lg text-gray-200">${expense.description}</p>
                            <p class="text-sm text-gray-400">${formatDate(expense.date)}</p>
                        </div>
                        <div class="flex items-center flex-shrink-0">
                            <p class="text-xl font-bold text-red-500 mr-4">${formatCurrency(expense.amount)}</p>
                            <button class="admin-only text-red-500 hover:text-red-400 p-1 delete-expense-btn" data-id="${expense.id}">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2 non-admin-only" style="display: none;">বিস্তারিত দেখতে ক্লিক করুন</p>
                `;
                expenseContainer.appendChild(card);
            });
            lucide.createIcons();
            updateUIVisibility();
        };

        const loadExpenses = (fromCacheOnly = false) => {
    const cachedData = loadFromLocalStorage('expenses');
    if (cachedData) {
        allExpenses = cachedData;
        renderExpenses(allExpenses);
        calculateAndUpdateTotals();
    }
    if(fromCacheOnly) return;

    const q = query(collection(db, "expenses"), orderBy("date", "desc"));
    return onSnapshot(q, async (snapshot) => {
        const expensesWithDetails = await Promise.all(snapshot.docs.map(async (doc) => {
            const expense = { id: doc.id, ...doc.data() };
            const detailsSnapshot = await getDocs(collection(db, `expenses/${doc.id}/details`));
            expense.details = detailsSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            expense.amount = expense.details.reduce((sum, item) => sum + item.price, 0);
            return expense;
        }));
        allExpenses = expensesWithDetails;
        renderExpenses(allExpenses);
        saveToLocalStorage('expenses', allExpenses);
        calculateAndUpdateTotals();
    }, (error) => console.error("Error loading expenses list:", error.message));
};

        window.showContributorFormModal = async (contributorId = null, isZakat = false) => {
            const collectionName = isZakat ? 'zakat_contributors' : 'contributors';
            let existingData = {};
            if (contributorId) {
                const dataSource = isZakat ? allZakatContributors : allContributors;
                existingData = dataSource.find(c => c.id === contributorId) || {};
            }
            const title = contributorId ? 'দাতার তথ্য এডিট' : (isZakat ? 'নতুন যাকাত দাতা যোগ' : 'নতুন দাতা যোগ');
            const content = `<form id="contributor-form" class="space-y-4">
                <input type="text" id="name" placeholder="নাম" class="w-full bg-card-light p-3 rounded-lg" value="${existingData.name || ''}" required>
                <input type="text" id="fatherName" placeholder="পিতার নাম (ঐচ্ছিক)" class="w-full bg-card-light p-3 rounded-lg" value="${existingData.fatherName || ''}">
                <input type="tel" id="phone" placeholder="ফোন নম্বর (ঐচ্ছিক)" class="w-full bg-card-light p-3 rounded-lg" value="${existingData.phone || ''}">
                <input type="text" id="address" placeholder="ঠিকানা (ঐচ্ছিক)" class="w-full bg-card-light p-3 rounded-lg" value="${existingData.address || ''}">
            </form>`;
            const footer = `<button id="save-contributor-btn" class="bg-accent text-white px-6 py-2 rounded-lg">সেভ করুন</button>`;
            createModal(title, content, footer);

            document.getElementById('save-contributor-btn').addEventListener('click', async () => {
                const form = document.getElementById('contributor-form');
                if (!form.checkValidity()) return form.reportValidity();
                const data = { 
                    name: form.name.value, 
                    fatherName: form.fatherName.value, 
                    address: form.address.value, 
                    phone: form.phone.value || null,
                    createdAt: existingData.createdAt || Timestamp.now() 
                };
                try {
                    if (contributorId) {
                        await setDoc(doc(db, collectionName, contributorId), data);
                        showToast('তথ্য আপডেট হয়েছে!');
                    } else {
                        await addDoc(collection(db, collectionName), data);
                        showToast('নতুন দাতা যোগ হয়েছে!');
                    }
                    closeModal();
                } catch (e) { showToast('সেভ করতে সমস্যা হয়েছে', true); console.error(e); }
            });
        };

        const showContributorDetailsModal = (contributorId, isZakat = false) => {
            const dataSource = isZakat ? allZakatContributors : allContributors;
            const contributor = dataSource.find(c => c.id === contributorId);
            if (!contributor) {
                showToast('দাতার তথ্য লোড করা যায়নি।', true);
                return;
            }
            const donations = contributor.donations || [];
            
            const historyTabsHTML = `
                <div class="flex border-b border-gray-600 mb-2">
                    <button data-view="all" class="history-tab nav-tab text-sm px-3 py-2 active">সকল অনুদান</button>
                    <button data-view="monthly" class="history-tab nav-tab text-sm px-3 py-2">মাসিক হিসাব</button>
                    <button data-view="yearly" class="history-tab nav-tab text-sm px-3 py-2">বাৎসরিক হিসাব</button>
                </div>
                <div id="donation-history-content" class="max-h-60 overflow-y-auto bg-card-light p-2 rounded-lg">
                    <!-- History content will be rendered here -->
                </div>
            `;

            const phoneHTML = contributor.phone 
                ? `<p class="admin-only" style="display: none;"><strong>ফোন:</strong> <a href="tel:${contributor.phone}" class="text-accent hover:underline">${contributor.phone}</a></p>` 
                : '';

            let content = `<div class="space-y-2 mb-4">
                <p><strong>নাম:</strong> ${contributor.name}</p>
                <p><strong>পিতার নাম:</strong> ${contributor.fatherName || 'N/A'}</p>
                <p><strong>ঠিকানা:</strong> ${contributor.address || 'N/A'}</p>
                ${phoneHTML}
            </div><div class="admin-only" style="display: none;"><button id="add-new-donation-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg mb-4">নতুন অনুদান যোগ</button></div><h4 class="text-lg font-bold mb-2">অনুদান ইতিহাস</h4>${historyTabsHTML}`;
            
            const footer = `<button id="edit-contributor-btn" class="admin-only bg-blue-600 text-white px-4 py-2 rounded-lg">এডিট</button><button id="delete-contributor-btn" class="admin-only bg-red-600 text-white px-4 py-2 rounded-lg">ডিলিট</button>`;
            
            createModal('দাতার বিস্তারিত', content, footer);
            
            const historyContainer = document.querySelector('#donation-history-content').parentElement;
            let historyTouchStartX = 0;
            historyContainer.addEventListener('touchstart', e => { historyTouchStartX = e.changedTouches[0].screenX; e.stopPropagation(); }, { passive: true });
            historyContainer.addEventListener('touchend', e => {
                const touchEndX = e.changedTouches[0].screenX;
                e.stopPropagation();
                if (Math.abs(historyTouchStartX - touchEndX) < 40) return;

                const tabs = Array.from(historyContainer.querySelectorAll('.history-tab'));
                const activeIndex = tabs.findIndex(t => t.classList.contains('active'));
                
                if (touchEndX < historyTouchStartX) { // Swipe Left
                    if (activeIndex < tabs.length - 1) tabs[activeIndex + 1].click();
                } else { // Swipe Right
                    if (activeIndex > 0) tabs[activeIndex - 1].click();
                }
            }, { passive: true });

            const historyContentEl = document.getElementById('donation-history-content');

            const renderAllDonations = (donationsList) => {
                const tableHTML = `<table class="w-full text-left"><thead><tr><th class="p-2">তারিখ</th><th class="p-2 text-right">পরিমাণ</th><th class="p-2 text-center admin-only" style="display: none;">অ্যাকশন</th></tr></thead><tbody>${donationsList.map(d => `<tr><td class="p-2">${formatDate(d.date)}</td><td class="p-2 text-right">${formatCurrency(d.amount)}</td><td class="p-2 text-center admin-only" style="display: none;"><button class="edit-donation-btn text-blue-400 hover:text-blue-300 mr-2" data-contributor-id="${contributor.id}" data-donation-id="${d.id}" data-is-zakat="${isZakat}"><i data-lucide="edit" class="w-4 h-4"></i></button><button class="delete-donation-btn text-red-500" data-contributor-id="${contributor.id}" data-donation-id="${d.id}" data-is-zakat="${isZakat}"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`).join('') || '<tr><td colspan="3" class="text-center p-4">কোনো অনুদান নেই।</td></tr>'}</tbody></table>`;
                historyContentEl.innerHTML = tableHTML;
                lucide.createIcons();
                updateUIVisibility();
            };

            const renderMonthlyDonations = (donationsList) => {
                const monthlyData = donationsList.reduce((acc, d) => {
                    const date = new Date(d.date.seconds * 1000);
                    const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`; // YYYY-MM
                    if (!acc[key]) {
                        acc[key] = { total: 0, year: date.getFullYear(), month: date.toLocaleString('bn-BD', { month: 'long' }) };
                    }
                    acc[key].total += d.amount;
                    return acc;
                }, {});
                const sortedMonths = Object.keys(monthlyData).sort().reverse();
                let tableHTML = `<table class="w-full text-left"><thead><tr><th class="p-2">মাস</th><th class="p-2 text-right">মোট পরিমাণ</th></tr></thead><tbody>`;
                if (sortedMonths.length === 0) { tableHTML += `<tr><td colspan="2" class="text-center p-4">কোনো অনুদান নেই।</td></tr>`; }
                else { sortedMonths.forEach(key => {
                        const data = monthlyData[key];
                        tableHTML += `<tr><td class="p-2">${data.month}, ${data.year.toLocaleString('bn-BD', { useGrouping: false })}</td><td class="p-2 text-right">${formatCurrency(data.total)}</td></tr>`;
                    });
                }
                tableHTML += `</tbody></table>`;
                historyContentEl.innerHTML = tableHTML;
            };

            const renderYearlyDonations = (donationsList) => {
                const yearlyData = donationsList.reduce((acc, d) => {
                    const year = new Date(d.date.seconds * 1000).getFullYear();
                    if (!acc[year]) { acc[year] = 0; }
                    acc[year] += d.amount;
                    return acc;
                }, {});
                const sortedYears = Object.keys(yearlyData).sort().reverse();
                let tableHTML = `<table class="w-full text-left"><thead><tr><th class="p-2">বছর</th><th class="p-2 text-right">মোট পরিমাণ</th></tr></thead><tbody>`;
                if (sortedYears.length === 0) { tableHTML += `<tr><td colspan="2" class="text-center p-4">কোনো অনুদান নেই।</td></tr>`; }
                else { sortedYears.forEach(year => {
                        tableHTML += `<tr><td class="p-2">${parseInt(year).toLocaleString('bn-BD', { useGrouping: false })}</td><td class="p-2 text-right">${formatCurrency(yearlyData[year])}</td></tr>`;
                    });
                }
                tableHTML += `</tbody></table>`;
                historyContentEl.innerHTML = tableHTML;
            };

            // Initial Render
            renderAllDonations(donations);
            
            // Add Listeners
            document.querySelectorAll('.history-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    document.querySelectorAll('.history-tab').forEach(t => t.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    const view = e.currentTarget.dataset.view;
                    if (view === 'all') renderAllDonations(donations);
                    else if (view === 'monthly') renderMonthlyDonations(donations);
                    else if (view === 'yearly') renderYearlyDonations(donations);
                });
            });

            document.getElementById('add-new-donation-btn').addEventListener('click', () => showDonationFormModal(contributor.id, () => showContributorDetailsModal(contributorId, isZakat), isZakat));
            document.getElementById('edit-contributor-btn').addEventListener('click', () => showContributorFormModal(contributor.id, isZakat));
            document.getElementById('delete-contributor-btn').addEventListener('click', () => window.deleteContributor(contributor.id, isZakat));
            updateUIVisibility();
        };
        
        const showZakatContributorDetailsModal = (contributorId) => showContributorDetailsModal(contributorId, true);

        window.editDonation = async (contributorId, donationId, isZakat = false) => {
            const collectionName = isZakat ? 'zakat_contributors' : 'contributors';
            const donationSnap = await getDoc(doc(db, `${collectionName}/${contributorId}/donations`, donationId));
            if (!donationSnap.exists()) {
                showToast('অনুদানটি পাওয়া যায়নি।', true);
                return;
            }
            const donationData = donationSnap.data();

            const content = `<form id="edit-donation-form" class="space-y-4">
                <input type="number" id="edit-donation-amount" placeholder="পরিমাণ" class="w-full bg-card-light p-3 rounded-lg" value="${donationData.amount}" required>
                <input type="date" id="edit-donation-date" class="w-full bg-card-light p-3 rounded-lg" value="${dateToInputFormat(donationData.date)}" required>
            </form>`;
            const footer = `<button id="update-donation-btn" class="bg-accent text-white px-6 py-2 rounded-lg">আপডেট করুন</button>`;

            createModal('অনুদান এডিট করুন', content, footer);

            document.getElementById('update-donation-btn').addEventListener('click', async () => {
                const newAmount = Number(document.getElementById('edit-donation-amount').value);
                const newDate = document.getElementById('edit-donation-date').value;

                if (newAmount <= 0 || !newDate) {
                    showToast('সঠিক পরিমাণ এবং তারিখ দিন।', true);
                    return;
                }

                try {
                    await updateDoc(doc(db, `${collectionName}/${contributorId}/donations`, donationId), {
                        amount: newAmount,
                        date: Timestamp.fromDate(new Date(newDate))
                    });
                    showToast('অনুদান আপডেট হয়েছে!');
                    closeModal();
                    // No need to call showContributorDetailsModal as onSnapshot will handle the update
                } catch (e) {
                    showToast('আপডেট করতে সমস্যা হয়েছে।', true);
                    console.error(e);
                }
            });
        };

        const showDonationFormModal = (contributorId, onSaveCallback, isZakat = false) => {
            const collectionName = isZakat ? 'zakat_contributors' : 'contributors';
            const content = `<form id="donation-form"><div class="mb-4"><label class="block mb-2">পরিমাণ</label><input type="number" id="amount" class="w-full bg-card-light p-3 rounded-lg" required></div><div class="mb-4"><label class="block mb-2">তারিখ</label><input type="date" id="date" class="w-full bg-card-light p-3 rounded-lg" value="${new Date().toISOString().split('T')[0]}" required></div></form>`;
            const footer = `<button id="save-donation-btn" class="bg-accent text-white px-6 py-2 rounded-lg">সেভ করুন</button>`;
            createModal('নতুন অনুদান', content, footer);
            document.getElementById('save-donation-btn').addEventListener('click', async () => {
                const form = document.getElementById('donation-form');
                if (!form.checkValidity()) return form.reportValidity();
                const data = { amount: Number(form.amount.value), date: Timestamp.fromDate(new Date(form.date.value)) };
                try {
                    await addDoc(collection(db, `${collectionName}/${contributorId}/donations`), data);
                    showToast('অনুদান যোগ হয়েছে!');
                    closeModal();
                    if (onSaveCallback) onSaveCallback();
                } catch(e) { showToast('সেভ করতে সমস্যা হয়েছে', true); }
            });
        };

       const showExpenseFormModal = () => {
    detailedExpenses = []; // Reset details
    const content = `
        <form id="expense-form" class="space-y-4" onsubmit="return false;">
            <input type="text" id="description" placeholder="বিবরণ" class="w-full bg-card-light p-3 rounded-lg" required>
            <input type="tel" id="phone" placeholder="ফোন নম্বর (ঐচ্ছিক)" class="w-full bg-card-light p-3 rounded-lg">
            <input type="date" id="date" class="w-full bg-card-light p-3 rounded-lg" value="${new Date().toISOString().split('T')[0]}" required>
            <div class="bg-card-light p-4 rounded-lg">
                <h4 class="text-lg font-semibold mb-2">বিস্তারিত ব্যয়</h4>
                <div id="detailed-expenses-list" class="space-y-2 mb-3"></div>
                
                <div id="detail-expense-adder" class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="detail-name" placeholder="পণ্যের বিবরণ" class="w-full sm:flex-grow bg-gray-700 p-2 rounded-lg text-sm">
                    <input type="number" id="detail-price" placeholder="মূল্য" class="w-full sm:w-24 bg-gray-700 p-2 rounded-lg text-sm">
                    <button type="button" id="add-detail-item-btn" class="w-full sm:w-auto bg-blue-600 text-white p-2 rounded-lg flex-shrink-0 flex justify-center items-center"><i data-lucide="plus"></i></button>
                </div>

            </div>
            <div>
                <label class="font-bold">মোট পরিমাণ:</label>
                <input type="text" id="total-amount" class="w-full bg-gray-700 p-3 rounded-lg mt-1" value="${formatCurrency(0)}" readonly>
            </div>
        </form>`;
    const footer = `<button id="save-expense-btn" class="bg-accent text-white px-6 py-2 rounded-lg">সেভ করুন</button>`;

    const modal = createModal('নতুন ব্যয়ের হিসাব', content, footer);
    if (!modal) return;

    const updateDetailedExpensesUI = () => {
        const listEl = modal.querySelector('#detailed-expenses-list');
        const totalAmountEl = modal.querySelector('#total-amount');
        if (!listEl || !totalAmountEl) return;

        let total = 0;
        listEl.innerHTML = '';
        detailedExpenses.forEach((item, index) => {
            total += item.price;
            const itemEl = document.createElement('div');
            itemEl.className = 'flex justify-between items-center bg-gray-700 p-2 rounded';
            itemEl.innerHTML = `
                <span class="text-sm">${item.name}</span>
                <div class="flex items-center gap-2">
                    <span class="text-sm">${formatCurrency(item.price)}</span>
                    <button type="button" class="remove-detail-item-btn" data-index="${index}"><i data-lucide="x-circle" class="w-4 h-4 text-red-500"></i></button>
                </div>
            `;
            listEl.appendChild(itemEl);
        });

        totalAmountEl.value = formatCurrency(total);
        lucide.createIcons();

        modal.querySelectorAll('.remove-detail-item-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const indexToRemove = parseInt(e.currentTarget.dataset.index, 10);
                detailedExpenses.splice(indexToRemove, 1);
                updateDetailedExpensesUI();
            });
        });
    };

    const addDetailItemBtn = modal.querySelector('#add-detail-item-btn');
    const detailNameInput = modal.querySelector('#detail-name');
    const detailPriceInput = modal.querySelector('#detail-price');

    const addDetailedExpenseItem = () => {
        const name = detailNameInput.value.trim();
        const price = Number(detailPriceInput.value);
        if (name && price > 0) {
            detailedExpenses.push({ name, price });
            updateDetailedExpensesUI();
            detailNameInput.value = '';
            detailPriceInput.value = '';
            detailNameInput.focus();
        } else {
            showToast('অনুগ্রহ করে পণ্যের নাম এবং সঠিক মূল্য যোগ করুন।', true);
        }
    };

    addDetailItemBtn.addEventListener('click', addDetailedExpenseItem);

    detailPriceInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            addDetailedExpenseItem();
        }
    });
    detailNameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            addDetailedExpenseItem();
        }
    });

    const saveBtn = modal.querySelector('#save-expense-btn');
    saveBtn.addEventListener('click', async () => {
        const form = modal.querySelector('#expense-form');

        if (!form.description.value.trim()) {
            showToast('অনুগ্রহ করে ব্যয়ের একটি বিবরণ দিন।', true);
            form.description.focus();
            return;
        }

        if (detailedExpenses.length === 0) {
            showToast('অনুগ্রহ করে কমপক্ষে একটি বিস্তারিত ব্যয় যোগ করুন।', true);
            return;
        }

        const totalAmount = detailedExpenses.reduce((sum, item) => sum + item.price, 0);

        const data = {
            description: form.description.value,
            amount: totalAmount,
            date: Timestamp.fromDate(new Date(form.date.value)),
            phone: form.phone.value || null
        };

        try {
            const expenseDocRef = await addDoc(collection(db, 'expenses'), data);

            const batch = writeBatch(db);
            detailedExpenses.forEach(detail => {
                const detailDocRef = doc(collection(db, `expenses/${expenseDocRef.id}/details`));
                batch.set(detailDocRef, detail);
            });
            await batch.commit();

            showToast('ব্যয়ের হিসাব সেভ হয়েছে!');
            closeModal();
        } catch (e) {
            showToast('সেভ করতে সমস্যা হয়েছে', true);
            console.error("Error saving expense:", e);
        }
    });

    updateDetailedExpensesUI();
};

window.viewExpenseDetails = (expenseId) => {
    const expense = allExpenses.find(e => e.id === expenseId);
    if(!expense) {
        showToast("ব্যয়ের হিসাব পাওয়া যায়নি", true);
        return;
    }
    const details = expense.details || [];

    let detailsHtml = '<p>কোনো বিস্তারিত বিবরণ নেই।</p>';
    if (details.length > 0) {
        detailsHtml = `<table class="w-full text-left mt-2">
            <thead class="bg-card-light"><tr><th class="p-2">বিবরণ</th><th class="p-2 text-right">টাকা</th><th class="p-2 text-center admin-only" style="display:none;">অ্যাকশন</th></tr></thead>
            <tbody>
                ${details.map(d => `<tr>
                    <td class="p-2 border-t border-gray-700">${d.name}</td>
                    <td class="p-2 border-t border-gray-700 text-right">${formatCurrency(d.price)}</td>
                    <td class="p-2 border-t border-gray-700 text-center admin-only" style="display:none;">
                        <button class="edit-expense-detail-btn text-blue-400 hover:text-blue-300 mr-2" data-expense-id="${expenseId}" data-detail-id="${d.id}"><i data-lucide="edit" class="w-4 h-4"></i></button>
                        <button class="delete-expense-detail-btn text-red-500 hover:text-red-400" data-expense-id="${expenseId}" data-detail-id="${d.id}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                </tr>`).join('')}
            </tbody>
        </table>`;
    }
    
    // === পরিবর্তিত রেসপন্সিভ লেআউট ===
    const addNewDetailForm = `
        <div class="admin-only mt-4 pt-4 border-t border-gray-600" style="display:none;">
            <h5 class="font-bold text-md mb-2">নতুন বিস্তারিত যোগ করুন</h5>
            <div class="flex flex-col sm:flex-row gap-2">
                <input type="text" id="new-detail-name" placeholder="পণ্যের বিবরণ" class="w-full sm:flex-grow bg-gray-700 p-2 rounded-lg text-sm" required>
                <input type="number" id="new-detail-price" placeholder="মূল্য" class="w-full sm:w-24 bg-gray-700 p-2 rounded-lg text-sm" required>
                <button type="button" id="add-new-detail-btn" class="w-full sm:w-auto bg-blue-600 text-white p-2 rounded-lg flex-shrink-0 flex justify-center items-center"><i data-lucide="plus"></i></button>
            </div>
        </div>
    `;

    const content = `
        <div class="space-y-2">
            <p><strong>বিবরণ:</strong> ${expense.description}</p>
            <p><strong>তারিখ:</strong> ${formatDate(expense.date)}</p>
            <p><strong>মোট ব্যয়:</strong> ${formatCurrency(expense.amount)}</p>
            ${expense.phone ? `<p><strong>ফোন:</strong> ${expense.phone}</p>` : ''}
            <hr class="border-gray-600 my-2">
            <h4 class="font-bold text-lg">বিস্তারিত</h4>
            <div class="max-h-60 overflow-y-auto">${detailsHtml}</div>
            ${addNewDetailForm}
        </div>
    `;
    createModal('বিস্তারিত খরচের ইতিহাস', content, '');
    lucide.createIcons();
    updateUIVisibility();

    const addNewDetailBtn = document.getElementById('add-new-detail-btn');
    if (addNewDetailBtn) {
        addNewDetailBtn.addEventListener('click', async () => {
            const nameInput = document.getElementById('new-detail-name');
            const priceInput = document.getElementById('new-detail-price');
            const name = nameInput.value.trim();
            const price = Number(priceInput.value);

            if (!name || price <= 0) {
                showToast('সঠিক নাম এবং মূল্য দিন।', true);
                return;
            }

            try {
                await addDoc(collection(db, `expenses/${expenseId}/details`), { name, price });

                showToast('নতুন বিবরণ যোগ হয়েছে!');
                closeModal();
                window.viewExpenseDetails(expenseId);

            } catch (e) {
                showToast('বিবরণ যোগ করতে সমস্যা হয়েছে।', true);
                console.error(e);
            }
        });
    }
};

window.editExpenseDetail = async (expenseId, detailId) => {
    const expense = allExpenses.find(e => e.id === expenseId);
    const detail = expense?.details.find(d => d.id === detailId);
    if (!detail) {
        showToast('বিবরণটি পাওয়া যায়নি।', true);
        return;
    }

    const content = `<form id="edit-detail-form" class="space-y-4">
        <input type="text" id="edit-detail-name" placeholder="পণ্যের নাম" class="w-full bg-card-light p-3 rounded-lg" value="${detail.name}" required>
        <input type="number" id="edit-detail-price" placeholder="টাকা" class="w-full bg-card-light p-3 rounded-lg" value="${detail.price}" required>
    </form>`;
    const footer = `<button id="save-edited-detail-btn" class="bg-accent text-white px-6 py-2 rounded-lg">সেভ করুন</button>`;

    createModal('ব্যয়ের বিবরণ এডিট', content, footer);

    document.getElementById('save-edited-detail-btn').addEventListener('click', async () => {
        const newName = document.getElementById('edit-detail-name').value.trim();
        const newPrice = Number(document.getElementById('edit-detail-price').value);

        if (!newName || newPrice <= 0) {
            showToast('সঠিক নাম এবং মূল্য দিন।', true);
            return;
        }

        try {
            await updateDoc(doc(db, `expenses/${expenseId}/details`, detailId), { name: newName, price: newPrice });
            showToast('বিবরণ আপডেট হয়েছে!');
            closeModal();
        } catch (e) {
            showToast('আপডেট করতে সমস্যা হয়েছে।', true);
            console.error(e);
        }
    });
};

window.deleteExpenseDetail = (expenseId, detailId) => {
    showConfirmModal('নিশ্চিতকরণ', 'আপনি কি এই ব্যয়ের বিবরণটি মুছে ফেলতে চান?', async () => {
        try {
            await deleteDoc(doc(db, `expenses/${expenseId}/details`, detailId));
            showToast('বিবরণ মুছে ফেলা হয়েছে।');
            closeModal();
        } catch (e) {
            showToast('মুছে ফেলতে সমস্যা হয়েছে।', true);
            console.error(e);
        }
    });
};
        
        // --- EVENT MANAGEMENT (MODIFIED FOR OFFLINE) ---
        const loadEvents = (fromCacheOnly = false) => {
    const cachedData = loadFromLocalStorage('events');
    if (cachedData) {
        allEvents = cachedData;
        renderEvents(allEvents);
        calculateAndUpdateTotals();
    }
    if(fromCacheOnly) return;

    const q = query(collection(db, "events"), orderBy("date", "desc"));
    return onSnapshot(q, async (snapshot) => {
        const eventsWithData = await Promise.all(snapshot.docs.map(async (doc) => {
            const event = { id: doc.id, ...doc.data() };
            const donorsSnapshot = await getDocs(collection(db, `events/${event.id}/donors`));
            
            event.donors = await Promise.all(donorsSnapshot.docs.map(async (donorDoc) => {
                const donorData = { id: donorDoc.id, ...donorDoc.data() };
                const donationsSnapshot = await getDocs(collection(db, `events/${event.id}/donors/${donorDoc.id}/donations`));
                donorData.donations = donationsSnapshot.docs.map(d => ({id: d.id, ...d.data()}));
                donorData.totalDonation = donorData.donations.reduce((sum, d) => sum + d.amount, 0);
                return donorData;
            }));
            
            event.totalDonation = event.donors.reduce((sum, d) => sum + d.totalDonation, 0);
            return event;
        }));
        allEvents = eventsWithData;
        renderEvents(allEvents);
        saveToLocalStorage('events', allEvents);
        calculateAndUpdateTotals();
    }, (error) => console.error("Error loading events:", error.message));
};
        
        const renderEvents = (events) => {
            const listEl = document.getElementById('events-list');
            if(!listEl) return;
            if(events.length === 0) {
                listEl.innerHTML = `<p class="col-span-full text-center text-gray-400">কোনো ইভেন্ট পাওয়া যায়নি।</p>`;
                return;
            }

             // Coordinator এর জন্য Fund page-এ বাটন লুকানো
    if (isCoordinator) {
        card.querySelectorAll('.admin-only').forEach(action => {
            action.style.display = 'none';
        });
    }

            listEl.innerHTML = '';
            events.forEach(event => {
                const card = document.createElement('div');
                card.className = 'bg-card p-4 rounded-lg shadow hover:shadow-lg hover:border-accent border border-transparent transition-all flex flex-col justify-between';
                
                const mainContent = document.createElement('div');
                mainContent.className = 'cursor-pointer event-details-link';
                mainContent.dataset.id = event.id;
                mainContent.innerHTML = `
                    <h3 class="text-xl font-bold accent-color">${event.name}</h3>
                    <p class="text-gray-400 text-sm">${formatDate(event.date)}</p>
                `;
                
                const footerContent = document.createElement('div');
                footerContent.className = 'flex justify-between items-center mt-3 pt-3 border-t border-gray-600/50';
                footerContent.innerHTML = `
                    <p class="text-lg font-semibold">মোট অনুদান: ${formatCurrency(event.totalDonation)}</p>
                    <div class="admin-only flex items-center gap-2" style="display: none;">
                        <button class="edit-event-btn text-blue-400 hover:text-blue-300 p-1" data-id="${event.id}"><i data-lucide="edit" class="w-5 h-5"></i></button>
                        <button class="delete-event-btn text-red-500 hover:text-red-400 p-1" data-id="${event.id}"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                    </div>
                `;

                card.appendChild(mainContent);
                card.appendChild(footerContent);
                listEl.appendChild(card);
            });
            lucide.createIcons();
            updateUIVisibility();
        };

        window.showEditEventModal = (eventId) => {
            const eventData = allEvents.find(e => e.id === eventId);
            if (!eventData) {
                showToast('ইভেন্টটি পাওয়া যায়নি।', true);
                return;
            }

            const content = `<form id="edit-event-form" class="space-y-4">
                <input type="text" id="eventName" placeholder="ইভেন্টের নাম" class="w-full bg-card-light p-3 rounded-lg" value="${eventData.name}" required>
                <input type="date" id="eventDate" class="w-full bg-card-light p-3 rounded-lg" value="${dateToInputFormat(eventData.date)}" required>
            </form>`;
            const footer = `<button id="update-event-btn" class="bg-accent text-white px-6 py-2 rounded-lg">আপডেট করুন</button>`;
            
            createModal('ইভেন্ট এডিট করুন', content, footer);
            
            document.getElementById('update-event-btn').addEventListener('click', async () => {
                const form = document.getElementById('edit-event-form');
                if(!form.checkValidity()) return form.reportValidity();
                
                const updatedData = {
                    name: form.eventName.value,
                    date: Timestamp.fromDate(new Date(form.eventDate.value)),
                };

                try {
                    await updateDoc(doc(db, 'events', eventId), updatedData);
                    showToast('ইভেন্ট আপডেট হয়েছে!');
                    closeModal();
                } catch (e) {
                    showToast('আপডেট করতে সমস্যা হয়েছে', true);
                    console.error(e);
                }
            });
        };

        window.deleteEvent = (eventId) => {
            showConfirmModal('নিশ্চিতকরণ', 'এই ইভেন্টটি মুছে ফেললে এর সাথে সম্পর্কিত সকল দাতা এবং তাদের অনুদানের হিসাবও মুছে যাবে। আপনি কি নিশ্চিত?', async () => {
                showToast('ইভেন্ট মুছে ফেলা হচ্ছে...');
                try {
                    const batch = writeBatch(db);
                    const eventRef = doc(db, 'events', eventId);
                    
                    const eventData = allEvents.find(e => e.id === eventId);
                    if (eventData && eventData.donors) {
                        for (const donor of eventData.donors) {
                            if (donor.donations) {
                                for (const donation of donor.donations) {
                                    batch.delete(doc(db, `events/${eventId}/donors/${donor.id}/donations`, donation.id));
                                }
                            }
                            batch.delete(doc(db, `events/${eventId}/donors`, donor.id));
                        }
                    }
                    
                    batch.delete(eventRef);
                    
                    await batch.commit();
                    showToast('ইভেন্ট সফলভাবে মুছে ফেলা হয়েছে।', false);
                } catch (error) {
                    showToast('ইভেন্ট মুছতে সমস্যা হয়েছে।', true);
                    console.error("Error deleting event:", error);
                }
            });
        };

        const showAddEventModal = () => {
            const content = `<form id="event-form" class="space-y-4">
                <input type="text" id="eventName" placeholder="ইভেন্টের নাম" class="w-full bg-card-light p-3 rounded-lg" required>
                <input type="date" id="eventDate" class="w-full bg-card-light p-3 rounded-lg" value="${new Date().toISOString().split('T')[0]}" required>
            </form>`;
            const footer = `<button id="save-event-btn" class="bg-accent text-white px-6 py-2 rounded-lg">সেভ করুন</button>`;
            createModal('নতুন ইভেন্ট', content, footer);
            document.getElementById('save-event-btn').addEventListener('click', async () => {
                const form = document.getElementById('event-form');
                if(!form.checkValidity()) return form.reportValidity();
                const data = {
                    name: form.eventName.value,
                    date: Timestamp.fromDate(new Date(form.eventDate.value)),
                    createdAt: Timestamp.now()
                };
                try {
                    await addDoc(collection(db, 'events'), data);
                    showToast('নতুন ইভেন্ট যোগ হয়েছে!');
                    closeModal();
                } catch (e) {
                    showToast('সেভ করতে সমস্যা হয়েছে', true);
                    console.error(e);
                }
            });
        };

        window.showEventDetailsView = (eventId) => {
    document.getElementById('events-list-view').classList.add('hidden');
    const detailsView = document.getElementById('event-details-view');
    const eventData = allEvents.find(e => e.id === eventId);
    if (!eventData) {
        showToast('ইভেন্ট পাওয়া যায়নি।', true);
        return;
    }
    const backButton = document.getElementById('back-button');

    detailsView.innerHTML = `
        <div class="flex justify-between items-center mb-4">
            <div>
                <h2 class="text-2xl font-bold">${eventData.name}</h2>
                <p class="text-gray-400">${formatDate(eventData.date)}</p>
            </div>
            <button id="back-to-events-btn" class="bg-gray-600 text-white px-4 py-2 rounded-lg flex items-center gap-2"><i data-lucide="arrow-left"></i> ফিরে যান</button>
        </div>
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
            <h3 class="text-xl font-bold">ইভেন্টের দাতা তালিকা</h3>
            <button id="add-event-donor-btn" class="admin-only bg-accent text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-amber-600 w-full sm:w-auto"><i data-lucide="plus-circle" class="w-5 h-5"></i> নতুন দাতা</button>
        </div>
         <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
            <div class="relative w-full sm:max-w-sm">
                <input type="text" id="event-donor-search-input" class="w-full bg-card p-3 pl-10 rounded-lg border-2 border-transparent focus:border-accent focus:outline-none" placeholder="দাতা খুঁজুন (নাম, ঠিকানা)...">
                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
            </div>
            <div id="event-donor-counter" class="text-right text-gray-400 font-semibold w-full sm:w-auto">মোট দাতা: ০ জন</div>
        </div>
        <div id="event-donors-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    `;
    detailsView.classList.remove('hidden');
    if (backButton) backButton.classList.remove('hidden');
    
    lucide.createIcons();
    updateUIVisibility();

    // Save event details view state
    currentState.eventDetailsView = true;
    currentState.currentEventId = eventId;
    saveCurrentState();

    const goBack = () => {
        detailsView.classList.add('hidden');
        document.getElementById('events-list-view').classList.remove('hidden');
        if (backButton) backButton.classList.add('hidden');
        
        // Update state
        currentState.eventDetailsView = false;
        currentState.currentEventId = null;
        saveCurrentState();
    };

    document.getElementById('back-to-events-btn').addEventListener('click', goBack);
    if (backButton) backButton.onclick = goBack;
    
    document.getElementById('add-event-donor-btn').addEventListener('click', () => showEventDonorFormModal(eventId));
    
    const searchInput = document.getElementById('event-donor-search-input');
    currentEventDonors = eventData.donors || [];
    searchInput?.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const filtered = currentEventDonors.filter(d => 
            d.name.toLowerCase().includes(searchTerm) ||
            (d.address && d.address.toLowerCase().includes(searchTerm))
        );
        renderEventDonors(eventId, filtered);
    });

    renderEventDonors(eventId, currentEventDonors);
};
        
        const renderEventDonors = (eventId, donors) => {
            const listEl = document.getElementById('event-donors-list');
            const counterEl = document.getElementById('event-donor-counter');
            if(!listEl || !counterEl) return;

            counterEl.textContent = `মোট দাতা: ${new Intl.NumberFormat('bn-BD').format(donors.length)} জন`;

            if (donors.length === 0) {
                listEl.innerHTML = `<p class="col-span-full text-center text-gray-400">এই ইভেন্টে কোনো দাতার তথ্য পাওয়া যায়নি।</p>`;
                return;
            }
            listEl.innerHTML = '';
            donors.forEach(donor => {
                const card = document.createElement('div');
                card.className = 'bg-card-light p-4 rounded-lg shadow hover:shadow-lg hover:border-accent border border-transparent transition-all cursor-pointer event-donor-details-link';
                card.dataset.eventId = eventId;
                card.dataset.donorId = donor.id;
                card.innerHTML = `<h3 class="text-xl font-bold accent-color">${donor.name}</h3><p class="text-gray-400">${donor.address || ''}</p><p class="mt-2 text-lg font-semibold">মোট অনুদান: ${formatCurrency(donor.totalDonation)}</p>`;
                listEl.appendChild(card);
            });
        };

        const showEventDonorFormModal = (eventId, donorId = null) => {
            let existingData = {};
            if (donorId) {
                const event = allEvents.find(e => e.id === eventId);
                existingData = event?.donors.find(d => d.id === donorId) || {};
            }
            const title = donorId ? 'দাতার তথ্য এডিট' : 'নতুন দাতা যোগ';
            const content = `<form id="event-donor-form" class="space-y-4">
                <input type="text" id="name" placeholder="নাম" class="w-full bg-card-light p-3 rounded-lg" value="${existingData.name || ''}" required>
                <input type="text" id="fatherName" placeholder="পিতার নাম (ঐচ্ছিক)" class="w-full bg-card-light p-3 rounded-lg" value="${existingData.fatherName || ''}">
                <input type="tel" id="phone" placeholder="ফোন নম্বর (ঐচ্ছিক)" class="w-full bg-card-light p-3 rounded-lg" value="${existingData.phone || ''}">
                <input type="text" id="address" placeholder="ঠিকানা (ঐচ্ছিক)" class="w-full bg-card-light p-3 rounded-lg" value="${existingData.address || ''}">
            </form>`;
            const footer = `<button id="save-event-donor-btn" class="bg-accent text-white px-6 py-2 rounded-lg">সেভ করুন</button>`;
            createModal(title, content, footer);

            document.getElementById('save-event-donor-btn').addEventListener('click', async () => {
                const form = document.getElementById('event-donor-form');
                if (!form.checkValidity()) return form.reportValidity();
                const data = { 
                    name: form.name.value, 
                    fatherName: form.fatherName.value, 
                    address: form.address.value, 
                    phone: form.phone.value || null,
                    createdAt: existingData.createdAt || Timestamp.now() 
                };
                try {
                    const collectionRef = collection(db, `events/${eventId}/donors`);
                    if (donorId) {
                        await setDoc(doc(collectionRef, donorId), data);
                        showToast('তথ্য আপডেট হয়েছে!');
                    } else {
                        await addDoc(collectionRef, data);
                        showToast('নতুন দাতা যোগ হয়েছে!');
                    }
                    closeModal();
                } catch (e) { showToast('সেভ করতে সমস্যা হয়েছে', true); console.error(e); }
            });
        };

        window.showEventDonorDetailsModal = (eventId, donorId) => {
             const event = allEvents.find(e => e.id === eventId);
             const donor = event?.donors.find(d => d.id === donorId);
             if (!donor) {
                 showToast('দাতার তথ্য পাওয়া যায়নি।', true);
                 return;
             }
            const donations = donor.donations || [];
            
            let donationsHtml = `<table class="w-full text-left"><thead><tr><th class="p-2">তারিখ</th><th class="p-2 text-right">পরিমাণ</th><th class="p-2 text-center admin-only" style="display: none;">অ্যাকশন</th></tr></thead><tbody>${donations.map(d => `<tr><td class="p-2">${formatDate(d.date)}</td><td class="p-2 text-right">${formatCurrency(d.amount)}</td><td class="p-2 text-center admin-only" style="display: none;"><button class="edit-event-donation-btn text-blue-400 hover:text-blue-300 mr-2" data-event-id="${eventId}" data-donor-id="${donor.id}" data-donation-id="${d.id}"><i data-lucide="edit" class="w-4 h-4"></i></button><button class="delete-event-donation-btn text-red-500" data-event-id="${eventId}" data-donor-id="${donor.id}" data-donation-id="${d.id}"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`).join('') || '<tr><td colspan="3" class="text-center p-4">কোনো অনুদান নেই।</td></tr>'}</tbody></table>`;

            const phoneHTML = donor.phone 
                ? `<p class="admin-only" style="display: none;"><strong>ফোন:</strong> <a href="tel:${donor.phone}" class="text-accent hover:underline">${donor.phone}</a></p>` 
                : '';

            let content = `<div class="space-y-2 mb-4">
                <p><strong>নাম:</strong> ${donor.name}</p>
                <p><strong>পিতার নাম:</strong> ${donor.fatherName || 'N/A'}</p>
                <p><strong>ঠিকানা:</strong> ${donor.address || 'N/A'}</p>
                ${phoneHTML}
            </div>
            <div class="admin-only" style="display: none;"><button id="add-new-event-donation-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg mb-4">নতুন অনুদান যোগ</button></div>
            <h4 class="text-lg font-bold mb-2">অনুদান ইতিহাস</h4>
            <div class="max-h-60 overflow-y-auto bg-card-light p-2 rounded-lg">${donationsHtml}</div>`;
            
            const footer = `<button id="edit-event-donor-btn" class="admin-only bg-blue-600 text-white px-4 py-2 rounded-lg">এডিট</button><button id="delete-event-donor-btn" class="admin-only bg-red-600 text-white px-4 py-2 rounded-lg">ডিলিট</button>`;
            
            createModal('দাতার বিস্তারিত', content, footer);
            lucide.createIcons();
            updateUIVisibility();
            
            document.getElementById('add-new-event-donation-btn').addEventListener('click', () => showEventDonationFormModal(eventId, donor.id, () => showEventDonorDetailsModal(eventId, donor.id)));
            document.getElementById('edit-event-donor-btn').addEventListener('click', () => showEventDonorFormModal(eventId, donor.id));
            document.getElementById('delete-event-donor-btn').addEventListener('click', () => window.deleteEventDonor(eventId, donor.id));
        };
        
        window.editEventDonation = async (eventId, donorId, donationId) => {
            const event = allEvents.find(e => e.id === eventId);
            const donor = event?.donors.find(d => d.id === donorId);
            const donationData = donor?.donations.find(dn => dn.id === donationId);

            if (!donationData) {
                showToast('অনুদানটি পাওয়া যায়নি।', true);
                return;
            }

            const content = `<form id="edit-event-donation-form" class="space-y-4">
                <input type="number" id="edit-donation-amount" placeholder="পরিমাণ" class="w-full bg-card-light p-3 rounded-lg" value="${donationData.amount}" required>
                <input type="date" id="edit-donation-date" class="w-full bg-card-light p-3 rounded-lg" value="${dateToInputFormat(donationData.date)}" required>
            </form>`;
            const footer = `<button id="update-event-donation-btn" class="bg-accent text-white px-6 py-2 rounded-lg">আপডেট করুন</button>`;

            createModal('অনুদান এডিট করুন', content, footer);

            document.getElementById('update-event-donation-btn').addEventListener('click', async () => {
                const newAmount = Number(document.getElementById('edit-donation-amount').value);
                const newDate = document.getElementById('edit-donation-date').value;

                if (newAmount <= 0 || !newDate) {
                    showToast('সঠিক পরিমাণ এবং তারিখ দিন।', true);
                    return;
                }

                try {
                    await updateDoc(doc(db, `events/${eventId}/donors/${donorId}/donations`, donationId), {
                        amount: newAmount,
                        date: Timestamp.fromDate(new Date(newDate))
                    });
                    showToast('অনুদান আপডেট হয়েছে!');
                    closeModal();
                } catch (e) {
                    showToast('আপডেট করতে সমস্যা হয়েছে।', true);
                    console.error(e);
                }
            });
        };
        
        const showEventDonationFormModal = (eventId, donorId, onSaveCallback) => {
            const content = `<form id="event-donation-form"><div class="mb-4"><label class="block mb-2">পরিমাণ</label><input type="number" id="amount" class="w-full bg-card-light p-3 rounded-lg" required></div><div class="mb-4"><label class="block mb-2">তারিখ</label><input type="date" id="date" class="w-full bg-card-light p-3 rounded-lg" value="${new Date().toISOString().split('T')[0]}" required></div></form>`;
            const footer = `<button id="save-event-donation-btn" class="bg-accent text-white px-6 py-2 rounded-lg">সেভ করুন</button>`;
            createModal('নতুন অনুদান', content, footer);
            document.getElementById('save-event-donation-btn').addEventListener('click', async () => {
                const form = document.getElementById('event-donation-form');
                if (!form.checkValidity()) return form.reportValidity();
                const data = { amount: Number(form.amount.value), date: Timestamp.fromDate(new Date(form.date.value)) };
                try {
                    await addDoc(collection(db, `events/${eventId}/donors/${donorId}/donations`), data);
                    showToast('অনুদান যোগ হয়েছে!');
                    closeModal();
                    if (onSaveCallback) onSaveCallback();
                } catch(e) { showToast('সেভ করতে সমস্যা হয়েছে', true); }
            });
        };

        // --- BLOOD DONOR PAGE (MODIFIED FOR OFFLINE) ---
        const loadBloodDonors = (fromCacheOnly = false) => {
    const cachedData = loadFromLocalStorage('donors');
    if (cachedData) {
        allBloodDonors = cachedData;
        renderBloodDonors(allBloodDonors);
        calculateAndUpdateTotals();
    }
    if(fromCacheOnly) return;

    const q = query(collection(db, "donors"), orderBy("name"));
    return onSnapshot(q, (snapshot) => {
        allBloodDonors = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderBloodDonors(allBloodDonors);
        saveToLocalStorage('donors', allBloodDonors);
        calculateAndUpdateTotals();
    }, (error) => console.error("Error loading blood donors:", error.message));
};
        
        const loadCoordinators = (fromCacheOnly = false) => {
    const cachedData = loadFromLocalStorage('coordinators');
    if(cachedData) {
        allCoordinators = cachedData;
    }
    if(fromCacheOnly) return;
    
    return onSnapshot(collection(db, 'coordinators'), (snapshot) => {
        allCoordinators = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        saveToLocalStorage('coordinators', allCoordinators);
    }, (error) => console.error("Error loading coordinators:", error.message));
};

        const renderBloodDonors = (donors) => {
            const listEl = document.getElementById('blood-donors-list');
            const counterEl = document.getElementById('blood-donor-counter');
            if(!listEl || !counterEl) return;

            counterEl.textContent = `মোট রক্তদাতা: ${new Intl.NumberFormat('bn-BD').format(donors.length)} জন`;

            if (donors.length === 0) { listEl.innerHTML = `<p class="col-span-full text-center text-gray-400">কোনো রক্তদাতার তথ্য পাওয়া যায়নি।</p>`; return; }
            listEl.innerHTML = '';
            const groupColors = { 'A+': 'bg-red-600', 'A-': 'bg-red-600', 'B+': 'bg-yellow-600', 'B-': 'bg-yellow-600', 'AB+': 'bg-purple-600', 'AB-': 'bg-purple-600', 'O+': 'bg-green-600', 'O-': 'bg-green-600', 'জানা নেই': 'bg-gray-500' };
            donors.forEach(donor => {
                const card = document.createElement('div');
                card.className = 'bg-card p-4 rounded-lg shadow text-center cursor-pointer hover:border-accent border border-transparent transition-all donor-details-link';
                card.dataset.id = donor.id;
                const isNegative = donor.group.includes('-');
                card.innerHTML = `<div class="flex justify-center mb-2"><span class="group-badge ${groupColors[donor.group] || 'bg-gray-500'} ${isNegative ? 'negative' : ''}">${donor.group}</span></div><h3 class="text-lg font-bold">${donor.name}</h3><p class="text-sm text-gray-400">${donor.address}</p><p class="text-sm text-gray-300 mt-1 flex items-center justify-center gap-1"><i data-lucide="phone" class="w-4 h-4"></i>${donor.phone}</p>`;
                listEl.appendChild(card);
            });
            lucide.createIcons();
        };
        
        // Donor page specific visibility update
const updateDonorPageVisibility = () => {
    const donorAdminPanel = document.getElementById('donor-admin-panel');
    const donorPanelTitle = document.getElementById('donor-panel-title');
    const coordinatorManagementSection = document.getElementById('coordinator-management-section');
    
    if (!donorAdminPanel || !donorPanelTitle || !coordinatorManagementSection) return;
    
    if (isSuperAdmin) {
        donorPanelTitle.textContent = 'সুপার অ্যাডমিন প্যানেল';
        coordinatorManagementSection.style.display = 'block';
        donorAdminPanel.style.display = 'block';
    } else if (isCoordinator) {
        donorPanelTitle.textContent = 'সমন্বয়কারী প্যানেল';
        coordinatorManagementSection.style.display = 'none';
        donorAdminPanel.style.display = 'block';
    } else if (isAddOnlyAdmin) {
        donorPanelTitle.textContent = 'এডমিন প্যানেল';
        coordinatorManagementSection.style.display = 'none';
        donorAdminPanel.style.display = 'block';
    } else {
        donorAdminPanel.style.display = 'none';
    }
    
    // Show edit/delete buttons in donor section for coordinators and addonly_admin
    // But addonly_admin can only add, so we'll handle them separately
    if (isCoordinator) {
        document.querySelectorAll('#donor-page .edit-only, #donor-page .delete-only').forEach(el => {
            el.style.display = '';
        });
    }
    
    // For addonly_admin, they can only add in donor page, so hide edit/delete
    if (isAddOnlyAdmin) {
        document.querySelectorAll('#donor-page .edit-only, #donor-page .delete-only').forEach(el => {
            el.style.display = 'none';
        });
    }
};

    
const showBloodDonorFormModal = (donorId = null) => {
            let d = {};
            if (donorId) {
                d = allBloodDonors.find(donor => donor.id === donorId) || {};
            }
            const title = donorId ? 'রক্তদাতার তথ্য এডিট' : 'নতুন রক্তদাতা যোগ';
            const content = `<form id="donor-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="name" placeholder="নাম" class="w-full bg-card-light p-3 rounded-lg" value="${d.name || ''}" required>
                <input type="text" id="fatherName" placeholder="পিতার নাম" class="w-full bg-card-light p-3 rounded-lg" value="${d.fatherName || ''}">
                <input type="text" id="address" placeholder="ঠিকানা" class="w-full bg-card-light p-3 rounded-lg" value="${d.address || ''}" required>
                <input type="tel" id="phone" placeholder="মোবাইল নম্বর" class="w-full bg-card-light p-3 rounded-lg" value="${d.phone || ''}" required>
                <select id="group" class="w-full bg-card-light p-3 rounded-lg" required><option value="">রক্তের গ্রুপ</option>${['A+', 'A-', 'B+', 'B-', 'O+', 'O-', 'AB+', 'AB-', 'জানা নেই'].map(g => `<option value="${g}" ${d.group === g ? 'selected' : ''}>${g}</option>`).join('')}</select>
                <div><label>জন্ম তারিখ</label><input type="date" id="dob" class="w-full bg-card-light p-3 rounded-lg" value="${d.dob ? dateToInputFormat(d.dob) : ''}"></div>
                <div><label>শেষ রক্তদানের তারিখ</label><input type="date" id="lastDonation" class="w-full bg-card-light p-3 rounded-lg" value="${d.lastDonation ? dateToInputFormat(d.lastDonation) : ''}"></div>
            </form>`;
            const footer = `<button id="save-donor-btn" class="bg-accent text-white px-6 py-2 rounded-lg">সেভ করুন</button>`;
            createModal(title, content, footer);

            document.getElementById('save-donor-btn').addEventListener('click', async () => {
                const form = document.getElementById('donor-form');
                if (!form.checkValidity()) return form.reportValidity();
                const data = {
                    name: form.name.value, fatherName: form.fatherName.value, address: form.address.value, phone: form.phone.value, group: form.group.value,
                    dob: form.dob.value ? Timestamp.fromDate(new Date(form.dob.value)) : null,
                    lastDonation: form.lastDonation.value ? Timestamp.fromDate(new Date(form.lastDonation.value)) : null,
                };
                try {
                    if (donorId) {
                        await setDoc(doc(db, 'donors', donorId), data);
                        showToast('তথ্য আপডেট হয়েছে!');
                    } else {
                        await addDoc(collection(db, 'donors'), data);
                        showToast('নতুন রক্তদাতা যোগ হয়েছে!');
                    }
                    closeModal();
                } catch (e) { showToast('সেভ করতে সমস্যা হয়েছে', true); console.error(e); }
            });
        };

        // showDonorDetailsModal ফাংশনে নিচের কোডটি রিপ্লেস করুন:

const showDonorDetailsModal = (donorId) => {
    const donor = allBloodDonors.find(d => d.id === donorId);
    if (!donor) return showToast('রক্তদাতা খুঁজে পাওয়া যায়নি', true);

    // Phone number visibility logic
    let phoneHTML = '';
    if (canViewDonorPhone()) {
        phoneHTML = `<p><strong>মোবাইল:</strong> <a href="tel:${donor.phone}" class="text-accent hover:underline">${donor.phone}</a></p>`;
    } else {
        phoneHTML = `<p><strong>মোবাইল:</strong> <span class="text-gray-400">সমন্বয়কারীর সাথে যোগাযোগ করুন</span></p>`;
    }

    // Eligibility calculation
    let eligibility = '<span class="text-yellow-400">তথ্য নেই</span>';
    let nextDate = '';

    if (donor.dob) {
        const dobDate = new Date(donor.dob.seconds * 1000);
        const today = new Date();
        const eighteenthBirthday = new Date(dobDate.getFullYear() + 18, dobDate.getMonth(), dobDate.getDate());

        if (today < eighteenthBirthday) {
            eligibility = '<span class="text-yellow-400 font-bold">১৮ বছর পূর্ণ হয়নি</span>';
            nextDate = `<p><strong>১৮ বছর পূর্ণ হবে:</strong> ${eighteenthBirthday.toLocaleDateString('bn-BD', { day: 'numeric', month: 'long', year: 'numeric' })}</p>`;
        } else {
            if (donor.lastDonation) {
                const lastDonationDate = new Date(donor.lastDonation.seconds * 1000);
                const nextDonationDate = new Date(new Date(lastDonationDate).setMonth(lastDonationDate.getMonth() + 4));
                if (new Date() > nextDonationDate) {
                    eligibility = '<span class="text-green-400 font-bold">রক্তদানে প্রস্তুত</span>';
                    nextDate = '';
                } else {
                    eligibility = '<span class="text-red-400 font-bold">এখন প্রস্তুত নন</span>';
                    nextDate = `<p><strong>পরবর্তী সম্ভাব্য তারিখ:</strong> ${nextDonationDate.toLocaleDateString('bn-BD', { day: 'numeric', month: 'long', year: 'numeric' })}</p>`;
                }
            } else {
                eligibility = '<span class="text-green-400 font-bold">রক্তদানে প্রস্তুত</span>';
                nextDate = '';
            }
        }
    } else {
        if (donor.lastDonation) {
             const lastDonationDate = new Date(donor.lastDonation.seconds * 1000);
             const nextDonationDate = new Date(new Date(lastDonationDate).setMonth(lastDonationDate.getMonth() + 4));
             if (new Date() > nextDonationDate) {
                 eligibility = '<span class="text-green-400 font-bold">রক্তদানে প্রস্তুত</span>';
             } else {
                 eligibility = '<span class="text-red-400 font-bold">এখন প্রস্তুত নন</span>';
                 nextDate = `<p><strong>পরবর্তী সম্ভাব্য তারিখ:</strong> ${nextDonationDate.toLocaleDateString('bn-BD', { day: 'numeric', month: 'long', year: 'numeric' })}</p>`;
             }
        } else {
            eligibility = '<span class="text-green-400 font-bold">রক্তদানে প্রস্তুত</span>';
        }
    }

    // নতুন ট্যাব সিস্টেম
    const content = `
        <div class="space-y-2 mb-4">
            <p><strong>নাম:</strong> ${donor.name}</p>
            <p><strong>পিতার নাম:</strong> ${donor.fatherName || 'N/A'}</p>
            <p><strong>ঠিকানা:</strong> ${donor.address}</p>
            ${phoneHTML}
            <p><strong>রক্তের গ্রুপ:</strong> <span class="font-bold">${donor.group}</span></p>
            <p><strong>জন্ম তারিখ:</strong> ${donor.dob ? formatDate(donor.dob) : 'N/A'}</p>
            <p><strong>শেষ রক্তদান:</strong> ${donor.lastDonation ? formatDate(donor.lastDonation) : 'N/A'}</p>
            <hr class="border-gray-600 my-2">
            <p><strong>যোগ্যতার স্ট্যাটাস:</strong> ${eligibility}</p>
            ${nextDate}
        </div>

        <!-- নতুন ট্যাব নেভিগেশন -->
        <div class="flex border-b border-gray-600 mb-4">
            <button data-tab="donation-history" class="donor-details-tab nav-tab py-2 px-4 text-sm active">রক্তদান হিস্ট্রি</button>
            <button data-tab="ratings" class="donor-details-tab nav-tab py-2 px-4 text-sm">রেটিং ও কমেন্ট</button>
        </div>

        <!-- ডোনেশন হিস্ট্রি ট্যাব -->
        <div id="donation-history-tab" class="donor-tab-content active">
            <div class="admin-only mb-4" style="display: none;">
                <button id="add-donation-record-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                    <i data-lucide="plus" class="w-4 h-4"></i> নতুন রক্তদান রেকর্ড যোগ
                </button>
            </div>
            <div id="donation-history-list" class="max-h-60 overflow-y-auto">
                লোড হচ্ছে...
            </div>
        </div>

        <!-- রেটিং ট্যাব -->
        <div id="ratings-tab" class="donor-tab-content hidden">
            <div class="mb-4">
                <h4 class="text-lg font-bold mb-2">নতুন রেটিং দিন</h4>
                <form id="rating-form" class="space-y-3">
                    <div>
                        <label class="block mb-1 text-sm">আপনার নাম</label>
                        <input type="text" id="rating-user-name" class="w-full bg-card-light p-2 rounded-lg" placeholder="আপনার নাম লিখুন" required>
                    </div>
                    <div>
                        <label class="block mb-1 text-sm">স্টার রেটিং</label>
                        <div class="flex gap-1" id="star-rating">
                            ${[1,2,3,4,5].map(star => `
                                <button type="button" class="star-btn text-2xl text-gray-400 hover:text-yellow-400" data-rating="${star}">★</button>
                            `).join('')}
                        </div>
                        <input type="hidden" id="selected-rating" value="0" required>
                    </div>
                    <div>
                        <label class="block mb-1 text-sm">কমেন্ট</label>
                        <textarea id="rating-comment" class="w-full bg-card-light p-2 rounded-lg" rows="3" placeholder="আপনার অভিজ্ঞতা শেয়ার করুন..."></textarea>
                    </div>
                    <button type="submit" class="bg-accent text-white px-4 py-2 rounded-lg w-full">রেটিং সাবমিট করুন</button>
                </form>
            </div>
            <div id="ratings-list" class="max-h-60 overflow-y-auto space-y-3">
                লোড হচ্ছে...
            </div>
        </div>
    `;
    
    const footer = `
        ${canViewDonorPhone() ? `<button id="call-donor-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg flex items-center gap-2" data-phone="${donor.phone}"><i data-lucide="phone"></i>কল করুন</button>` : ''}
        <button id="edit-donor-btn" class="edit-only bg-blue-600 text-white px-4 py-2 rounded-lg" data-id="${donor.id}" style="display: none;">এডিট</button>
        <button id="delete-donor-btn" class="delete-only bg-red-600 text-white px-4 py-2 rounded-lg" data-id="${donor.id}" style="display: none;">ডিলিট</button>
    `;
    
    createModal('রক্তদাতার বিস্তারিত', content, footer);
    
    // নতুন ফাংশন কল
    loadDonationHistory(donorId);
    loadRatings(donorId);
    setupDonorDetailsTabs();
    setupStarRating();
    setupRatingForm(donorId);
    
    updateUIVisibility();
    
    // Existing event listeners
    document.getElementById('call-donor-btn')?.addEventListener('click', () => {
        window.location.href = `tel:${donor.phone}`;
    });
    document.getElementById('edit-donor-btn')?.addEventListener('click', () => showBloodDonorFormModal(donor.id));
    document.getElementById('delete-donor-btn')?.addEventListener('click', () => deleteBloodDonor(donor.id));
    document.getElementById('add-donation-record-btn')?.addEventListener('click', () => showAddDonationRecordModal(donor.id));
};

    // রক্তদান হিস্ট্রি লোড করার ফাংশন
const loadDonationHistory = async (donorId) => {
    try {
        const donationsSnapshot = await getDocs(collection(db, `donors/${donorId}/donations`));
        const donations = donationsSnapshot.docs.map(doc => ({ 
            id: doc.id, 
            ...doc.data() 
        })).sort((a, b) => b.date.seconds - a.date.seconds);

        const container = document.getElementById('donation-history-list');
        if (!container) return;

        if (donations.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-400 p-4">কোনো রক্তদানের রেকর্ড নেই।</p>';
            return;
        }

        let totalDonations = donations.length;
        let lastDonationDate = donations[0]?.date ? formatDate(donations[0].date) : 'N/A';

        const html = `
            <div class="bg-card-light p-3 rounded-lg mb-3">
                <p class="font-bold text-accent">সারসংক্ষেপ</p>
                <p>মোট রক্তদান: <strong>${totalDonations} বার</strong></p>
                <p>সর্বশেষ রক্তদান: <strong>${lastDonationDate}</strong></p>
            </div>
            <div class="space-y-2">
                ${donations.map(donation => `
                    <div class="bg-card-light p-3 rounded-lg flex justify-between items-center">
                        <div>
                            <p class="font-semibold">${formatDate(donation.date)}</p>
                            ${donation.location ? `<p class="text-sm text-gray-400">${donation.location}</p>` : ''}
                            ${donation.notes ? `<p class="text-sm mt-1">${donation.notes}</p>` : ''}
                        </div>
                        <div class="admin-only flex gap-2" style="display: none;">
                            <button class="edit-donation-record text-blue-400" data-id="${donation.id}" data-donor-id="${donorId}">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                            </button>
                            <button class="delete-donation-record text-red-500" data-id="${donation.id}" data-donor-id="${donorId}">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;

        container.innerHTML = html;
        lucide.createIcons();
        updateUIVisibility();

        // Event listeners for edit/delete buttons
        document.querySelectorAll('.edit-donation-record').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const donationId = e.target.closest('button').dataset.id;
                showEditDonationRecordModal(donorId, donationId);
            });
        });

        document.querySelectorAll('.delete-donation-record').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const donationId = e.target.closest('button').dataset.id;
                deleteDonationRecord(donorId, donationId);
            });
        });

    } catch (error) {
        console.error("Error loading donation history:", error);
        document.getElementById('donation-history-list').innerHTML = 
            '<p class="text-center text-red-400 p-4">ডেটা লোড করতে সমস্যা হয়েছে।</p>';
    }
};

// রেটিং লোড করার ফাংশন
// রেটিং লোড করার ফাংশন - আপডেটেড ভার্সন
const loadRatings = async (donorId) => {
    try {
        const ratingsSnapshot = await getDocs(collection(db, `donors/${donorId}/ratings`));
        const ratings = ratingsSnapshot.docs.map(doc => ({ 
            id: doc.id, 
            ...doc.data() 
        })).sort((a, b) => b.createdAt.seconds - a.createdAt.seconds);

        const container = document.getElementById('ratings-list');
        if (!container) return;

        if (ratings.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-400 p-4">কোনো রেটিং নেই। প্রথম রেটিং দিন!</p>';
            return;
        }

        // Average rating calculation
        const averageRating = ratings.length > 0 
            ? (ratings.reduce((sum, rating) => sum + rating.rating, 0) / ratings.length).toFixed(1)
            : 0;

        const html = `
            <div class="bg-card-light p-3 rounded-lg mb-3">
                <p class="font-bold text-accent">রেটিং সারসংক্ষেপ</p>
                <p>মোট রেটিং: <strong>${ratings.length} টি</strong></p>
                <p>গড় রেটিং: <strong>${averageRating} ★</strong></p>
            </div>
            <div class="space-y-3">
                ${ratings.map(rating => `
                    <div class="bg-card-light p-3 rounded-lg rating-card">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-semibold">${rating.userName}</p>
                                        <p class="text-yellow-400 text-lg">${'★'.repeat(rating.rating)}${'☆'.repeat(5-rating.rating)}</p>
                                    </div>
                                    <div class="admin-only flex gap-2" style="display: none;">
                                        <button class="delete-rating-btn text-red-500 hover:text-red-400" data-donor-id="${donorId}" data-rating-id="${rating.id}">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                                <span class="text-sm text-gray-400">${formatDate(rating.createdAt)}</span>
                            </div>
                        </div>
                        ${rating.comment ? `<p class="text-sm mt-2">${rating.comment}</p>` : ''}
                    </div>
                `).join('')}
            </div>
        `;

        container.innerHTML = html;
        lucide.createIcons();
        updateUIVisibility();

        // ডিলেট বাটনে ইভেন্ট লিসেনার যোগ করুন
        document.querySelectorAll('.delete-rating-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const donorId = e.currentTarget.dataset.donorId;
                const ratingId = e.currentTarget.dataset.ratingId;
                deleteRating(donorId, ratingId);
            });
        });

    } catch (error) {
        console.error("Error loading ratings:", error);
        document.getElementById('ratings-list').innerHTML = 
            '<p class="text-center text-red-400 p-4">রেটিং লোড করতে সমস্যা হয়েছে।</p>';
    }
};
// ট্যাব সেটআপ ফাংশন
const setupDonorDetailsTabs = () => {
    document.querySelectorAll('.donor-details-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
            const targetTab = e.currentTarget.dataset.tab;
            
            // Update active tab
            document.querySelectorAll('.donor-details-tab').forEach(t => t.classList.remove('active'));
            e.currentTarget.classList.add('active');
            
            // Show target content
            document.querySelectorAll('.donor-tab-content').forEach(content => content.classList.add('hidden'));
            document.getElementById(`${targetTab}-tab`).classList.remove('hidden');
        });
    });
};

// স্টার রেটিং সেটআপ ফাংশন
const setupStarRating = () => {
    const starButtons = document.querySelectorAll('.star-btn');
    const selectedRatingInput = document.getElementById('selected-rating');
    
    starButtons.forEach((star, index) => {
        star.addEventListener('click', () => {
            const rating = parseInt(star.dataset.rating);
            selectedRatingInput.value = rating;
            
            // Update star display
            starButtons.forEach((s, i) => {
                if (i < rating) {
                    s.classList.remove('text-gray-400');
                    s.classList.add('text-yellow-400');
                } else {
                    s.classList.remove('text-yellow-400');
                    s.classList.add('text-gray-400');
                }
            });
        });
        
        star.addEventListener('mouseover', () => {
            const hoverRating = parseInt(star.dataset.rating);
            starButtons.forEach((s, i) => {
                if (i < hoverRating) {
                    s.classList.add('text-yellow-300');
                }
            });
        });
        
        star.addEventListener('mouseout', () => {
            const currentRating = parseInt(selectedRatingInput.value);
            starButtons.forEach((s, i) => {
                s.classList.remove('text-yellow-300');
                if (i < currentRating) {
                    s.classList.add('text-yellow-400');
                } else {
                    s.classList.add('text-gray-400');
                }
            });
        });
    });
};

// রেটিং ফর্ম সেটআপ ফাংশন
const setupRatingForm = (donorId) => {
    const ratingForm = document.getElementById('rating-form');
    if (!ratingForm) return;

    ratingForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const userName = document.getElementById('rating-user-name').value.trim();
        const rating = parseInt(document.getElementById('selected-rating').value);
        const comment = document.getElementById('rating-comment').value.trim();

        if (!userName) {
            showToast('আপনার নাম দিন।', true);
            return;
        }

        if (rating === 0) {
            showToast('দয়া করে স্টার রেটিং নির্বাচন করুন।', true);
            return;
        }

        try {
            await addDoc(collection(db, `donors/${donorId}/ratings`), {
                userName,
                rating,
                comment,
                createdAt: Timestamp.now()
            });

            showToast('রেটিং সফলভাবে জমা হয়েছে!');
            ratingForm.reset();
            
            // Reset stars
            document.querySelectorAll('.star-btn').forEach(star => {
                star.classList.remove('text-yellow-400');
                star.classList.add('text-gray-400');
            });
            document.getElementById('selected-rating').value = 0;
            
            // Reload ratings
            loadRatings(donorId);
            
        } catch (error) {
            showToast('রেটিং জমা দিতে সমস্যা হয়েছে।', true);
            console.error("Error submitting rating:", error);
        }
    });
};

// নতুন রক্তদান রেকর্ড যোগ করার মডাল
const showAddDonationRecordModal = (donorId) => {
    const content = `
        <form id="add-donation-form" class="space-y-4">
            <div>
                <label class="block mb-2">রক্তদানের তারিখ</label>
                <input type="date" id="donation-date" class="w-full bg-card-light p-3 rounded-lg" value="${new Date().toISOString().split('T')[0]}" required>
            </div>
            <div>
                <label class="block mb-2">স্থান (ঐচ্ছিক)</label>
                <input type="text" id="donation-location" class="w-full bg-card-light p-3 rounded-lg" placeholder="রক্তদানের স্থান">
            </div>
            <div>
                <label class="block mb-2">নোটস (ঐচ্ছিক)</label>
                <textarea id="donation-notes" class="w-full bg-card-light p-3 rounded-lg" rows="3" placeholder="অতিরিক্ত তথ্য..."></textarea>
            </div>
        </form>
    `;
    
    const footer = `<button id="save-donation-record-btn" class="bg-accent text-white px-6 py-2 rounded-lg">সেভ করুন</button>`;
    
    createModal('নতুন রক্তদান রেকর্ড', content, footer);
    
    document.getElementById('save-donation-record-btn').addEventListener('click', async () => {
        const form = document.getElementById('add-donation-form');
        const date = form.querySelector('#donation-date').value;
        const location = form.querySelector('#donation-location').value.trim();
        const notes = form.querySelector('#donation-notes').value.trim();

        if (!date) {
            showToast('রক্তদানের তারিখ প্রয়োজন।', true);
            return;
        }

        try {
            await addDoc(collection(db, `donors/${donorId}/donations`), {
                date: Timestamp.fromDate(new Date(date)),
                location: location || null,
                notes: notes || null,
                createdAt: Timestamp.now()
            });

            showToast('রক্তদান রেকর্ড সফলভাবে যোগ হয়েছে!');
            closeModal();
            loadDonationHistory(donorId);
            
        } catch (error) {
            showToast('রেকর্ড যোগ করতে সমস্যা হয়েছে।', true);
            console.error("Error adding donation record:", error);
        }
    });
};

// রক্তদান রেকর্ড এডিট মডাল
const showEditDonationRecordModal = async (donorId, donationId) => {
    try {
        const donationDoc = await getDoc(doc(db, `donors/${donorId}/donations`, donationId));
        if (!donationDoc.exists()) {
            showToast('রেকর্ডটি পাওয়া যায়নি।', true);
            return;
        }

        const donationData = donationDoc.data();
        const content = `
            <form id="edit-donation-form" class="space-y-4">
                <div>
                    <label class="block mb-2">রক্তদানের তারিখ</label>
                    <input type="date" id="edit-donation-date" class="w-full bg-card-light p-3 rounded-lg" value="${dateToInputFormat(donationData.date)}" required>
                </div>
                <div>
                    <label class="block mb-2">স্থান (ঐচ্ছিক)</label>
                    <input type="text" id="edit-donation-location" class="w-full bg-card-light p-3 rounded-lg" value="${donationData.location || ''}" placeholder="রক্তদানের স্থান">
                </div>
                <div>
                    <label class="block mb-2">নোটস (ঐচ্ছিক)</label>
                    <textarea id="edit-donation-notes" class="w-full bg-card-light p-3 rounded-lg" rows="3" placeholder="অতিরিক্ত তথ্য...">${donationData.notes || ''}</textarea>
                </div>
            </form>
        `;
        
        const footer = `<button id="update-donation-record-btn" class="bg-accent text-white px-6 py-2 rounded-lg">আপডেট করুন</button>`;
        
        createModal('রক্তদান রেকর্ড এডিট করুন', content, footer);
        
        document.getElementById('update-donation-record-btn').addEventListener('click', async () => {
            const form = document.getElementById('edit-donation-form');
            const date = form.querySelector('#edit-donation-date').value;
            const location = form.querySelector('#edit-donation-location').value.trim();
            const notes = form.querySelector('#edit-donation-notes').value.trim();

            if (!date) {
                showToast('রক্তদানের তারিখ প্রয়োজন।', true);
                return;
            }

            try {
                await updateDoc(doc(db, `donors/${donorId}/donations`, donationId), {
                    date: Timestamp.fromDate(new Date(date)),
                    location: location || null,
                    notes: notes || null
                });

                showToast('রেকর্ড সফলভাবে আপডেট হয়েছে!');
                closeModal();
                loadDonationHistory(donorId);
                
            } catch (error) {
                showToast('আপডেট করতে সমস্যা হয়েছে।', true);
                console.error("Error updating donation record:", error);
            }
        });

    } catch (error) {
        showToast('রেকর্ড লোড করতে সমস্যা হয়েছে।', true);
        console.error("Error loading donation record:", error);
    }
};

// রক্তদান রেকর্ড ডিলিট ফাংশন
const deleteDonationRecord = (donorId, donationId) => {
    showConfirmModal('নিশ্চিতকরণ', 'আপনি কি এই রক্তদান রেকর্ডটি মুছে ফেলতে চান?', async () => {
        try {
            await deleteDoc(doc(db, `donors/${donorId}/donations`, donationId));
            showToast('রেকর্ড মুছে ফেলা হয়েছে।');
            loadDonationHistory(donorId);
        } catch (error) {
            showToast('মুছে ফেলতে সমস্যা হয়েছে।', true);
            console.error("Error deleting donation record:", error);
        }
    });
};

// Helper function for phone visibility
const canViewDonorPhone = () => {
    return isSuperAdmin || isCoordinator || isAddOnlyAdmin;
};

        const showCoordinatorModal = (readOnly = false) => {
            const coordinators = allCoordinators || [];

            let adminSection = readOnly ? '' : `<div class="admin-only" style="display: none;"><h4 class="text-lg font-bold mt-6 mb-2">নতুন সমন্বয়কারী</h4><form id="coordinator-form" class="flex gap-2"><input type="text" id="name" placeholder="নাম" class="w-full bg-card-light p-2 rounded-lg" required><input type="tel" id="phone" placeholder="মোবাইল" class="w-full bg-card-light p-2 rounded-lg" required><button type="submit" class="bg-accent text-white px-4 rounded-lg">যোগ</button></form></div>`;
            
            const content = `<div class="space-y-3">${coordinators.map(c => `<div class="flex justify-between items-center bg-card-light p-3 rounded-lg"><div class="flex flex-col"><span>${c.name}</span><a href="tel:${c.phone}" class="text-gray-400 text-sm">${c.phone}</a></div><div><a href="tel:${c.phone}" class="text-green-500 p-2"><i data-lucide="phone"></i></a> ${readOnly ? '' : `<button class="delete-coordinator-btn admin-only text-red-500 p-2" style="display:none;" data-id="${c.id}"><i data-lucide="trash-2"></i></button>`}</div></div>`).join('') || '<p>কোনো সমন্বয়কারী নেই।</p>'}</div>${adminSection}`;
            createModal('সমন্বয়কারী তালিকা', content, '');
            updateUIVisibility();
            if(!readOnly) {
                const coordForm = document.getElementById('coordinator-form');
                if (coordForm) {
                    coordForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const form = e.target;
                        const data = { name: form.name.value, phone: form.phone.value };
                        try {
                            await addDoc(collection(db, 'coordinators'), data);
                            showToast('সমন্বয়কারী যোগ হয়েছে');
                            showCoordinatorModal();
                        } catch(err) { showToast('ত্রুটি হয়েছে', true); }
                    });
                }
            }
        };

        // --- DELETE LOGIC ---
        window.deleteExpense = (id) => showConfirmModal('নিশ্চিতকরণ', 'আপনি কি এই ব্যয়ের হিসাব মুছে ফেলতে চান?', async () => {
            const batch = writeBatch(db);
            const expense = allExpenses.find(e => e.id === id);
            if (expense && expense.details) {
                expense.details.forEach(d => batch.delete(doc(db, `expenses/${id}/details`, d.id)));
            }
            batch.delete(doc(db, 'expenses', id));
            await batch.commit();
            showToast('হিসাব মুছে ফেলা হয়েছে।');
        });
        
        window.deleteDonation = (contributorId, donationId, isZakat = false) => {
            const collectionName = isZakat ? 'zakat_contributors' : 'contributors';
            showConfirmModal('নিশ্চিতকরণ', 'আপনি কি এই অনুদানটি মুছে ফেলতে চান?', () => {
                deleteDoc(doc(db, `${collectionName}/${contributorId}/donations`, donationId)).then(() => {
                    showToast('অনুদান মুছে ফেলা হয়েছে।');
                    // onSnapshot will handle UI update
                }).catch(() => showToast('মুছে ফেলতে সমস্যা হয়েছে', true));
            });
        };

        window.deleteContributor = (id, isZakat = false) => {
            const collectionName = isZakat ? 'zakat_contributors' : 'contributors';
            showConfirmModal('নিশ্চিতকরণ', 'এই দাতাকে মুছে ফেললে তার সকল অনুদানের হিসাবও মুছে যাবে। আপনি কি নিশ্চিত?', async () => {
                const batch = writeBatch(db);
                const dataSource = isZakat ? allZakatContributors : allContributors;
                const contributor = dataSource.find(c => c.id === id);
                if (contributor && contributor.donations) {
                    contributor.donations.forEach(d => batch.delete(doc(db, `${collectionName}/${id}/donations`, d.id)));
                }
                batch.delete(doc(db, collectionName, id));
                await batch.commit();
                showToast('দাতাকে মুছে ফেলা হয়েছে।');
                closeModal();
            });
        };
        
        window.deleteEventDonation = (eventId, donorId, donationId) => showConfirmModal('নিশ্চিতকরণ', 'আপনি কি এই অনুদানটি মুছে ফেলতে চান?', () => {
            deleteDoc(doc(db, `events/${eventId}/donors/${donorId}/donations`, donationId)).then(() => {
                showToast('অনুদান মুছে ফেলা হয়েছে।');
                // onSnapshot will handle UI update
            }).catch(() => showToast('মুছে ফেলতে সমস্যা হয়েছে', true));
        });
        
        window.deleteEventDonor = (eventId, donorId) => showConfirmModal('নিশ্চিতকরণ', 'এই দাতাকে মুছে ফেললে তার সকল অনুদানের হিসাবও মুছে যাবে। আপনি কি নিশ্চিত?', async () => {
            const batch = writeBatch(db);
            const event = allEvents.find(e => e.id === eventId);
            const donor = event?.donors.find(d => d.id === donorId);
            if (donor && donor.donations) {
                donor.donations.forEach(d => batch.delete(doc(db, `events/${eventId}/donors/${donorId}/donations`, d.id)));
            }
            batch.delete(doc(db, `events/${eventId}/donors`, donorId));
            await batch.commit();
            showToast('দাতাকে মুছে ফেলা হয়েছে।');
            closeModal();
        });

        window.deleteBloodDonor = (id) => showConfirmModal('নিশ্চিতকরণ', 'আপনি কি এই রক্তদাতাকে মুছে ফেলতে চান?', () => {
            deleteDoc(doc(db, 'donors', id)).then(() => {
                showToast('রক্তদাতাকে মুছে ফেলা হয়েছে।');
                closeModal();
            }).catch(() => showToast('মুছে ফেলতে সমস্যা হয়েছে', true));
        });

        window.deleteCoordinator = (id) => showConfirmModal('নিশ্চিতকরণ', 'আপনি কি এই সমন্বয়কারীকে মুছে ফেলতে চান?', () => {
                 deleteDoc(doc(db, 'coordinators', id)).then(() => {
                    showToast('সমন্বয়কারীকে মুছে ফেলা হয়েছে।');
                    showCoordinatorModal();
                }).catch(() => showToast('ত্রুটি হয়েছে', true));
        });

        // --- EVENT LISTENERS SETUP ---
        const setupEventListeners = () => {
            // Main Navigation
            document.querySelectorAll('.main-nav-tab').forEach(tab => {
    tab.addEventListener('click', (e) => {
        document.querySelectorAll('.main-nav-tab').forEach(t => t.classList.remove('active'));
        const clickedTab = e.currentTarget;
        clickedTab.classList.add('active');
        
        const targetId = `${clickedTab.dataset.tab}-page`;
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        const targetPage = document.getElementById(targetId);
        if(targetPage) targetPage.classList.remove('hidden');
        document.getElementById('back-button').classList.add('hidden');

         // স্ক্রল ইভেন্ট লিসেনার যোগ করুন
    const mainContent = document.querySelector('main');
    if (mainContent) {
        mainContent.addEventListener('scroll', handleScroll);
    }

        // Save current tab state
        currentState.activeTab = clickedTab.dataset.tab;
        currentState.eventDetailsView = false;
        currentState.currentEventId = null;
        saveCurrentState();

        const tabName = clickedTab.dataset.tab;
        if (tabName === 'fund') {
            document.querySelector('#fund-page .fund-subtab.active')?.click();
        }
        
        // Load specific data for about page
        if (tabName === 'about') {
            loadManagementCommittee();
        }
    });
});

// Fund Sub-Navigation আপডেট করুন
document.querySelectorAll('.fund-subtab').forEach(tab => {
    tab.addEventListener('click', (e) => {
        document.querySelectorAll('.fund-subtab').forEach(t => t.classList.remove('active'));
        const clickedSubTab = e.currentTarget;
        clickedSubTab.classList.add('active');
        
        const targetId = `${clickedSubTab.dataset.subtab}-subpage`;
        document.querySelectorAll('.fund-subcontent').forEach(c => {
            c.classList.remove('active-subcontent');
        });
        const targetSubPage = document.getElementById(targetId);
        if(targetSubPage) {
            targetSubPage.classList.add('active-subcontent');
        }

        // Save sub tab state
        currentState.activeSubTab = clickedSubTab.dataset.subtab;
        saveCurrentState();
    });
});


            // Button Listeners
            document.getElementById('copy-bkash-btn')?.addEventListener('click', () => {
                const bkashNumber = document.getElementById('bkash-number-display')?.textContent;
                if(bkashNumber) {
                    const textArea = document.createElement('textarea');
                    textArea.value = bkashNumber;
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        showToast('নম্বর কপি হয়েছে!');
                    } catch (err) {
                        showToast('কপি করতে ব্যর্থ', true);
                    }
                    document.body.removeChild(textArea);
                }
            });
            document.getElementById('save-bkash-btn')?.addEventListener('click', async () => {
                 if (!isAdmin) return;
                 const newNumber = document.getElementById('bkash-number-input')?.value.trim();
                 if (newNumber) {
                       try {
                           await setDoc(doc(db, "settings", "main"), { bkashNumber: newNumber });
                           showToast('বিকাশ নম্বর আপডেট হয়েছে!');
                       } catch (error) { showToast('আপডেট ব্যর্থ হয়েছে', true); console.error(error); }
                 }
            });
            document.getElementById('add-contributor-btn')?.addEventListener('click', () => showContributorFormModal(null, false));
            document.getElementById('add-zakat-contributor-btn')?.addEventListener('click', () => showContributorFormModal(null, true));
            document.getElementById('add-expense-btn')?.addEventListener('click', () => showExpenseFormModal());
            document.getElementById('add-blood-donor-btn')?.addEventListener('click', () => showBloodDonorFormModal());
            document.getElementById('manage-coordinators-btn')?.addEventListener('click', () => showCoordinatorModal());
            document.getElementById('show-coordinators-btn')?.addEventListener('click', () => showCoordinatorModal(true));
            document.getElementById('add-event-btn')?.addEventListener('click', showAddEventModal);
            
            document.getElementById('manage-coordinators-btn')?.addEventListener('click', () => {
    if (isSuperAdmin) {
        showCoordinatorModal();
    } else {
        showToast('শুধুমাত্র সুপার অ্যাডমিন সমন্বয়কারী ব্যবস্থাপনা করতে পারেন।', true);
    }
});

            // Search Listeners
            document.getElementById('contributor-search-input')?.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filtered = allContributors.filter(c => 
                    c.name.toLowerCase().includes(searchTerm) ||
                    (c.address && c.address.toLowerCase().includes(searchTerm))
                );
                renderContributors(filtered);
            });
            
            document.getElementById('zakat-contributor-search-input')?.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filtered = allZakatContributors.filter(c => 
                    c.name.toLowerCase().includes(searchTerm) ||
                    (c.address && c.address.toLowerCase().includes(searchTerm))
                );
                renderZakatContributors(filtered);
            });

            document.getElementById('donor-search-input')?.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredDonors = allBloodDonors.filter(d => d.name.toLowerCase().includes(searchTerm) || d.group.toLowerCase().includes(searchTerm) || d.address.toLowerCase().includes(searchTerm));
                renderBloodDonors(filteredDonors);
            });

            // Download and Admin page listeners
            document.getElementById('download-txt-btn')?.addEventListener('click', () => handleDownload('txt'));
            document.getElementById('download-xlsx-btn')?.addEventListener('click', () => handleDownload('xlsx'));
            document.getElementById('export-data-btn')?.addEventListener('click', exportAllData);
            document.getElementById('import-data-btn')?.addEventListener('click', () => document.getElementById('import-file-input').click());
            document.getElementById('import-file-input')?.addEventListener('change', handleImportFile);

            // Admin পেজের Form Handler
document.addEventListener('DOMContentLoaded', function() {
    const addUserForm = document.getElementById('add-user-form');
    if (addUserForm) {
        addUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('new-user-email').value;
            const password = document.getElementById('new-user-password').value;
            const role = document.getElementById('new-user-role').value;
            
            // ভ্যালিডেশন চেক
            if (!email || !password) {
                showToast('ইমেইল এবং পাসওয়ার্ড প্রয়োজন', true);
                return;
            }
            
            try {
                await createUserWithRole(email, password, role);
                showToast('ব্যবহারকারী সফলভাবে যোগ হয়েছে');
                document.getElementById('add-user-form').reset();
                loadUsers(); // ইউজার লিস্ট রিফ্রেশ করুন
            } catch (error) {
                showToast('ব্যবহারকারী যোগ করতে সমস্যা হয়েছে', true);
                console.error("Error adding user:", error);
            }
        });
    }
});

            // Swipe Navigation Setup
            const mainContent = document.querySelector('main');
            const fundPage = document.getElementById('fund-page');

            let touchStartX = 0;
            let touchStartY = 0;

            const handleSwipe = (e, tabsSelector) => {
                const touchEndX = e.changedTouches[0].screenX;
                const touchEndY = e.changedTouches[0].screenY;
                const deltaX = touchEndX - touchStartX;
                const deltaY = touchEndY - touchStartY;

                if (Math.abs(deltaX) < 50 || Math.abs(deltaX) < Math.abs(deltaY)) {
                    return; // Ignore vertical scrolls and small horizontal movements
                }
                
                if (e.target.closest('.overflow-y-auto, .overflow-x-auto, input, select, textarea')) return;

                const tabs = Array.from(document.querySelectorAll(tabsSelector)).filter(t => t.offsetParent !== null);
                const activeIndex = tabs.findIndex(t => t.classList.contains('active'));

                if (activeIndex === -1) return;

                if (deltaX < 0) { // Swipe Left
                    if (activeIndex < tabs.length - 1) {
                        tabs[activeIndex + 1].click();
                    }
                } else { // Swipe Right
                    if (activeIndex > 0) {
                        tabs[activeIndex - 1].click();
                    }
                }
            };

            mainContent.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, { passive: true });

            mainContent.addEventListener('touchend', e => {
                if (!e.target.closest('#fund-page')) {
                     handleSwipe(e, '.main-nav-tab');
                }
            }, { passive: true });

            fundPage.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
                e.stopPropagation();
            }, { passive: true });

            fundPage.addEventListener('touchend', e => {
                handleSwipe(e, '.fund-subtab');
                e.stopPropagation();
            }, { passive: true });

            // Global Event Listener for dynamic elements
            document.body.addEventListener('click', (e) => {

                // Hide edit/delete functionality for addonly_admin and coordinator in non-donor sections
        if (isAddOnlyAdmin) {
        const editBtn = e.target.closest('.edit-contributor-btn, .edit-event-btn, .edit-expense-btn, .edit-donation-btn, .edit-expense-detail-btn, .edit-event-donation-btn');
        const deleteBtn = e.target.closest('.delete-contributor-btn, .delete-event-btn, .delete-expense-btn, .delete-donation-btn, .delete-expense-detail-btn, .delete-event-donation-btn');
        
        if (editBtn || deleteBtn) {
            e.stopPropagation();
            showToast('আপনার শুধুমাত্র ডেটা যোগ করার অনুমতি আছে। এডিট/ডিলেট করার অনুমতি নেই।', true);
            return;
        }
    }
    
    // Prevent coordinator from editing/deleting in fund page
    if (isCoordinator && e.target.closest('#fund-page')) {
        const addBtn = e.target.closest('#add-contributor-btn, #add-zakat-contributor-btn, #add-event-btn, #add-expense-btn');
        const editBtn = e.target.closest('.edit-contributor-btn, .edit-event-btn, .edit-expense-btn, .edit-donation-btn, .edit-expense-detail-btn, .edit-event-donation-btn');
        const deleteBtn = e.target.closest('.delete-contributor-btn, .delete-event-btn, .delete-expense-btn, .delete-donation-btn, .delete-expense-detail-btn, .delete-event-donation-btn');
        
        if (addBtn || editBtn || deleteBtn) {
            e.stopPropagation();
            showToast('সমন্বয়কারীর জন্য তহবিল পৃষ্ঠায় কোনো এডিট/ডিলেট/যোগ করার অনুমতি নেই।', true);
            return;
        }
    }

    // রেটিং ডিলেট বাটন হ্যান্ডলার
    const deleteRatingBtn = e.target.closest('.delete-rating-btn');
    if (deleteRatingBtn) {
        e.stopPropagation();
        const donorId = deleteRatingBtn.dataset.donorId;
        const ratingId = deleteRatingBtn.dataset.ratingId;
        deleteRating(donorId, ratingId);
    }

                // Modal close button
                if (e.target.closest('.modal-close-btn')) {
                    closeModal();
                }
                

                // Contributor Card Actions
                const editContributorBtn = e.target.closest('.edit-contributor-btn');
                if (editContributorBtn) {
                    e.stopPropagation();
                    showContributorFormModal(editContributorBtn.dataset.id, editContributorBtn.dataset.isZakat === 'true');
                }
                const deleteContributorBtn = e.target.closest('.delete-contributor-btn');
                if (deleteContributorBtn) {
                    e.stopPropagation();
                    deleteContributor(deleteContributorBtn.dataset.id, deleteContributorBtn.dataset.isZakat === 'true');
                }
                const contributorDetailsLink = e.target.closest('.contributor-details-link');
                if (contributorDetailsLink) {
                    showContributorDetailsModal(contributorDetailsLink.dataset.id, contributorDetailsLink.dataset.isZakat === 'true');
                }
                const editDonationBtn = e.target.closest('.edit-donation-btn');
                if (editDonationBtn) {
                    editDonation(editDonationBtn.dataset.contributorId, editDonationBtn.dataset.donationId, editDonationBtn.dataset.isZakat === 'true');
                }
                const deleteDonationBtn = e.target.closest('.delete-donation-btn');
                if (deleteDonationBtn) {
                    deleteDonation(deleteDonationBtn.dataset.contributorId, deleteDonationBtn.dataset.donationId, deleteDonationBtn.dataset.isZakat === 'true');
                }


                // Expense Card Actions
                const viewExpenseBtn = e.target.closest('.view-expense-details-btn');
                if (viewExpenseBtn) {
                    viewExpenseDetails(viewExpenseBtn.dataset.id);
                }
                const deleteExpenseBtn = e.target.closest('.delete-expense-btn');
                if (deleteExpenseBtn) {
                    e.stopPropagation();
                    deleteExpense(deleteExpenseBtn.dataset.id);
                }
                const editExpenseDetailBtn = e.target.closest('.edit-expense-detail-btn');
                if (editExpenseDetailBtn) {
                    editExpenseDetail(editExpenseDetailBtn.dataset.expenseId, editExpenseDetailBtn.dataset.detailId);
                }
                const deleteExpenseDetailBtn = e.target.closest('.delete-expense-detail-btn');
                if (deleteExpenseDetailBtn) {
                    deleteExpenseDetail(deleteExpenseDetailBtn.dataset.expenseId, deleteExpenseDetailBtn.dataset.detailId);
                }

                // Event Card Actions
                const eventDetailsLink = e.target.closest('.event-details-link');
                if (eventDetailsLink) {
                    showEventDetailsView(eventDetailsLink.dataset.id);
                }
                const editEventBtn = e.target.closest('.edit-event-btn');
                if (editEventBtn) {
                    e.stopPropagation();
                    showEditEventModal(editEventBtn.dataset.id);
                }
                const deleteEventBtn = e.target.closest('.delete-event-btn');
                if (deleteEventBtn) {
                    e.stopPropagation();
                    deleteEvent(deleteEventBtn.dataset.id);
                }
                const eventDonorDetailsLink = e.target.closest('.event-donor-details-link');
                if (eventDonorDetailsLink) {
                    showEventDonorDetailsModal(eventDonorDetailsLink.dataset.eventId, eventDonorDetailsLink.dataset.donorId);
                }
                const editEventDonationBtn = e.target.closest('.edit-event-donation-btn');
                if(editEventDonationBtn) {
                    editEventDonation(editEventDonationBtn.dataset.eventId, editEventDonationBtn.dataset.donorId, editEventDonationBtn.dataset.donationId);
                }
                const deleteEventDonationBtn = e.target.closest('.delete-event-donation-btn');
                if(deleteEventDonationBtn) {
                    deleteEventDonation(deleteEventDonationBtn.dataset.eventId, deleteEventDonationBtn.dataset.donorId, deleteEventDonationBtn.dataset.donationId);
                }


                // Blood Donor Actions
                const donorDetailsLink = e.target.closest('.donor-details-link');
                if (donorDetailsLink) {
                    showDonorDetailsModal(donorDetailsLink.dataset.id);
                }
                const callDonorBtn = e.target.closest('#call-donor-btn');
                if (callDonorBtn) {
                    window.location.href = `tel:${callDonorBtn.dataset.phone}`;
                }
                const editDonorBtn = e.target.closest('#edit-donor-btn');
                if (editDonorBtn) {
                    showBloodDonorFormModal(editDonorBtn.dataset.id);
                }
                const deleteDonorBtn = e.target.closest('#delete-donor-btn');
                if (deleteDonorBtn) {
                    deleteBloodDonor(deleteDonorBtn.dataset.id);
                }
                
                // Coordinator Actions
                const deleteCoordinatorBtn = e.target.closest('.delete-coordinator-btn');
                if(deleteCoordinatorBtn) {
                    deleteCoordinator(deleteCoordinatorBtn.dataset.id);
                }
            });
        };


        //Management Committee
        let managementCommittee = {};

const loadManagementCommittee = (fromCacheOnly = false) => {
    const cachedData = loadFromLocalStorage('management_committee');
    if (cachedData) {
        managementCommittee = cachedData;
        renderManagementCommittee();
    }
    if (fromCacheOnly) return;

    const docRef = doc(db, "management_committee", "members");
    return onSnapshot(docRef, (docSnap) => {
        if (docSnap.exists()) {
            managementCommittee = docSnap.data();
            renderManagementCommittee();
            saveToLocalStorage('management_committee', managementCommittee);
        } else {
            managementCommittee = {
                president: "[এখানে নাম যুক্ত হবে]",
                secretary: "[এখানে নাম যুক্ত হবে]",
                treasurer: "[এখানে নাম যুক্ত হবে]",
                vice_president: "[এখানে নাম যুক্ত হবে]",
                joint_secretary: "[এখানে নাম যুক্ত হবে]",
                organizational_secretary: "[এখানে নাম যুক্ত হবে]",
                publicity_secretary: "[এখানে নাম যুক্ত হবে]",
                office_secretary: "[এখানে নাম যুক্ত হবে]",
                executive_members: ["[একাধিক সদস্যের নাম যুক্ত হবে]"]
            };
            renderManagementCommittee();
        }
    }, (error) => console.error("Error loading management committee:", error.message));
};

//Management Committee রেন্ডার করার ফাংশন যোগ করুন
const renderManagementCommittee = () => {
    const committeeContainer = document.getElementById('management-committee-container');
    if (!committeeContainer) return;

    committeeContainer.innerHTML = `
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl font-bold accent-color border-b-2 border-accent/50 pb-2">আমাদের পরিচালনা কমিটি</h3>
            <button id="edit-committee-btn" class="admin-only bg-accent text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-amber-600" style="display: none;">
                <i data-lucide="edit" class="w-5 h-5"></i> কমিটি এডিট করুন
            </button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2 mb-6">
            <p><strong>সভাপতি:</strong> ${managementCommittee.president || '[এখানে নাম যুক্ত হবে]'}</p>
            <p><strong>সেক্রেটারি:</strong> ${managementCommittee.secretary || '[এখানে নাম যুক্ত হবে]'}</p>
            <p><strong>কোষাধ্যক্ষ:</strong> ${managementCommittee.treasurer || '[এখানে নাম যুক্ত হবে]'}</p>
            <p><strong>সহ-সভাপতি:</strong> ${managementCommittee.vice_president || '[এখানে নাম যুক্ত হবে]'}</p>
            <p><strong>যুগ্ম-সাধারণ সম্পাদক:</strong> ${managementCommittee.joint_secretary || '[এখানে নাম যুক্ত হবে]'}</p>
            <p><strong>সাংগঠনিক সম্পাদক:</strong> ${managementCommittee.organizational_secretary || '[এখানে নাম যুক্ত হবে]'}</p>
            <p><strong>প্রচার সম্পাদক:</strong> ${managementCommittee.publicity_secretary || '[এখানে নাম যুক্ত হবে]'}</p>
            <p><strong>দপ্তর সম্পাদক:</strong> ${managementCommittee.office_secretary || '[এখানে নাম যুক্ত হবে]'}</p>
            <p class="md:col-span-2"><strong>নির্বাহী সদস্য:</strong> ${Array.isArray(managementCommittee.executive_members) ? managementCommittee.executive_members.join(', ') : managementCommittee.executive_members || '[একাধিক সদস্যের নাম যুক্ত হবে]'}</p>
        </div>
    `;

    lucide.createIcons();
    updateUIVisibility();

    // Edit button event listener
    document.getElementById('edit-committee-btn')?.addEventListener('click', showEditCommitteeModal);
};

//Management Committee এডিট মডাল যোগ করুন
const showEditCommitteeModal = () => {
    const content = `
        <form id="committee-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="president" class="block mb-2 text-sm font-medium text-gray-300">সভাপতি</label>
                    <input type="text" id="president" class="w-full bg-card-light p-3 rounded-lg border border-gray-600 focus:border-accent focus:outline-none" value="${managementCommittee.president || ''}" placeholder="সভাপতির নাম">
                </div>
                <div>
                    <label for="secretary" class="block mb-2 text-sm font-medium text-gray-300">সেক্রেটারি</label>
                    <input type="text" id="secretary" class="w-full bg-card-light p-3 rounded-lg border border-gray-600 focus:border-accent focus:outline-none" value="${managementCommittee.secretary || ''}" placeholder="সেক্রেটারির নাম">
                </div>
                <div>
                    <label for="treasurer" class="block mb-2 text-sm font-medium text-gray-300">কোষাধ্যক্ষ</label>
                    <input type="text" id="treasurer" class="w-full bg-card-light p-3 rounded-lg border border-gray-600 focus:border-accent focus:outline-none" value="${managementCommittee.treasurer || ''}" placeholder="কোষাধ্যক্ষের নাম">
                </div>
                <div>
                    <label for="vice_president" class="block mb-2 text-sm font-medium text-gray-300">সহ-সভাপতি</label>
                    <input type="text" id="vice_president" class="w-full bg-card-light p-3 rounded-lg border border-gray-600 focus:border-accent focus:outline-none" value="${managementCommittee.vice_president || ''}" placeholder="সহ-সভাপতির নাম">
                </div>
                <div>
                    <label for="joint_secretary" class="block mb-2 text-sm font-medium text-gray-300">যুগ্ম-সাধারণ সম্পাদক</label>
                    <input type="text" id="joint_secretary" class="w-full bg-card-light p-3 rounded-lg border border-gray-600 focus:border-accent focus:outline-none" value="${managementCommittee.joint_secretary || ''}" placeholder="যুগ্ম-সাধারণ সম্পাদকের নাম">
                </div>
                <div>
                    <label for="organizational_secretary" class="block mb-2 text-sm font-medium text-gray-300">সাংগঠনিক সম্পাদক</label>
                    <input type="text" id="organizational_secretary" class="w-full bg-card-light p-3 rounded-lg border border-gray-600 focus:border-accent focus:outline-none" value="${managementCommittee.organizational_secretary || ''}" placeholder="সাংগঠনিক সম্পাদকের নাম">
                </div>
                <div>
                    <label for="publicity_secretary" class="block mb-2 text-sm font-medium text-gray-300">প্রচার সম্পাদক</label>
                    <input type="text" id="publicity_secretary" class="w-full bg-card-light p-3 rounded-lg border border-gray-600 focus:border-accent focus:outline-none" value="${managementCommittee.publicity_secretary || ''}" placeholder="প্রচার সম্পাদকের নাম">
                </div>
                <div>
                    <label for="office_secretary" class="block mb-2 text-sm font-medium text-gray-300">দপ্তর সম্পাদক</label>
                    <input type="text" id="office_secretary" class="w-full bg-card-light p-3 rounded-lg border border-gray-600 focus:border-accent focus:outline-none" value="${managementCommittee.office_secretary || ''}" placeholder="দপ্তর সম্পাদকের নাম">
                </div>
            </div>
            <div>
                <label for="executive_members" class="block mb-2 text-sm font-medium text-gray-300">নির্বাহী সদস্য (প্রতিটি নাম কমা দিয়ে আলাদা করুন)</label>
                <textarea id="executive_members" class="w-full bg-card-light p-3 rounded-lg border border-gray-600 focus:border-accent focus:outline-none" rows="3" placeholder="নির্বাহী সদস্যদের নাম কমা দিয়ে আলাদা করুন">${Array.isArray(managementCommittee.executive_members) ? managementCommittee.executive_members.join(', ') : managementCommittee.executive_members || ''}</textarea>
            </div>
        </form>
    `;

    const footer = `
        <button id="save-committee-btn" class="bg-accent text-white px-6 py-2 rounded-lg hover:bg-amber-600">সেভ করুন</button>
        <button id="cancel-committee-btn" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700">বাতিল</button>
    `;

    createModal('পরিচালনা কমিটি এডিট করুন', content, footer);

    // Event listeners
    document.getElementById('save-committee-btn').addEventListener('click', async () => {
        const form = document.getElementById('committee-form');
        
        const executiveMembersText = form.executive_members.value;
        const executiveMembersArray = executiveMembersText.split(',').map(item => item.trim()).filter(item => item !== '');

        const updatedData = {
            president: form.president.value || "[এখানে নাম যুক্ত হবে]",
            secretary: form.secretary.value || "[এখানে নাম যুক্ত হবে]",
            treasurer: form.treasurer.value || "[এখানে নাম যুক্ত হবে]",
            vice_president: form.vice_president.value || "[এখানে নাম যুক্ত হবে]",
            joint_secretary: form.joint_secretary.value || "[এখানে নাম যুক্ত হবে]",
            organizational_secretary: form.organizational_secretary.value || "[এখানে নাম যুক্ত হবে]",
            publicity_secretary: form.publicity_secretary.value || "[এখানে নাম যুক্ত হবে]",
            office_secretary: form.office_secretary.value || "[এখানে নাম যুক্ত হবে]",
            executive_members: executiveMembersArray.length > 0 ? executiveMembersArray : ["[একাধিক সদস্যের নাম যুক্ত হবে]"]
        };

        try {
            await setDoc(doc(db, "management_committee", "members"), updatedData);
            showToast('পরিচালনা কমিটি তথ্য সফলভাবে আপডেট হয়েছে!');
            closeModal();
        } catch (error) {
            showToast('আপডেট করতে সমস্যা হয়েছে', true);
            console.error("Error updating management committee:", error);
        }
    });

    document.getElementById('cancel-committee-btn').addEventListener('click', closeModal);
};

    // Current state management
let currentState = {
    activeTab: 'dashboard',
    activeSubTab: 'all-contributors',
    openModal: null,
    eventDetailsView: false,
    currentEventId: null
};

const saveCurrentState = () => {
    localStorage.setItem('appCurrentState', JSON.stringify(currentState));
};

const loadCurrentState = () => {
    const savedState = localStorage.getItem('appCurrentState');
    if (savedState) {
        currentState = JSON.parse(savedState);
        return true;
    }
    return false;
};

const restoreUIState = () => {
    // Restore main tab
    const mainTab = document.querySelector(`[data-tab="${currentState.activeTab}"]`);
    if (mainTab) {
        mainTab.click();
    }

    // Restore sub tab if on fund page
    if (currentState.activeTab === 'fund') {
        setTimeout(() => {
            const subTab = document.querySelector(`[data-subtab="${currentState.activeSubTab}"]`);
            if (subTab) {
                subTab.click();
            }
        }, 100);
    }

    // Restore event details view if applicable
    if (currentState.eventDetailsView && currentState.currentEventId) {
        setTimeout(() => {
            window.showEventDetailsView(currentState.currentEventId);
        }, 200);
    }
};

    // স্ক্রল ইভেন্ট হ্যান্ডলার
const handleScroll = () => {
    const mainContent = document.querySelector('main');
    if (mainContent.scrollTop > 10) {
        // ইউজার স্ক্রল করলে পুল টু রিফ্রESH ডিজেবল থাকবে
        document.getElementById('pull-to-refresh').style.display = 'none';
    } else {
        document.getElementById('pull-to-refresh').style.display = 'flex';
    }
};


        // --- DOWNLOAD AND ADMIN FEATURES ---
        
        /**
         * CORDOVA FILE HELPER
         * To use this feature, you must install the cordova-plugin-file:
         * > cordova plugin add cordova-plugin-file
         * * And add the following permission to your config.xml for Android:
         * <platform name="android">
         * ...
         * <config-file target="AndroidManifest.xml" parent="/manifest">
         * <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
         * </config-file>
         * ...
         * </platform>
        */
        const saveFileCordova = (fileName, blob) => {
            const dir = cordova.file.externalDataDirectory || cordova.file.dataDirectory;
            window.resolveLocalFileSystemURL(dir, (dirEntry) => {
                dirEntry.getFile(fileName, { create: true, exclusive: false }, (fileEntry) => {
                    fileEntry.createWriter((fileWriter) => {
                        fileWriter.onwriteend = () => {
                            showToast(`ফাইলটি সফলভাবে ${fileName} নামে সেভ হয়েছে।`);
                        };
                        fileWriter.onerror = (e) => {
                            showToast('ফাইল সেভ করতে সমস্যা হয়েছে।', true);
                            console.error('Write failed: ' + e.toString());
                        };
                        fileWriter.write(blob);
                    });
                }, (err) => showToast('ফাইল তৈরি করতে সমস্যা হয়েছে।', true));
            }, (err) => showToast('ডাইরেক্টরি খুঁজে পাওয়া যায়নি।', true));
        };


        const populateDateFilters = () => {
            const monthSelect = document.getElementById('report-month');
            const yearSelect = document.getElementById('report-year');
            if (!monthSelect || !yearSelect) return;

            const months = ["জানুয়ারি", "ফেব্রুয়ারি", "মার্চ", "এপ্রিল", "মে", "জুন", "জুলাই", "আগস্ট", "সেপ্টেম্বর", "অক্টোবর", "নভেম্বর", "ডিসেম্বর"];
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth();

            monthSelect.innerHTML = months.map((month, index) => `<option value="${index}" ${index === currentMonth ? 'selected' : ''}>${month}</option>`).join('');
            
            yearSelect.innerHTML = '';
            for (let i = currentYear; i >= 2020; i--) {
                yearSelect.innerHTML += `<option value="${i}">${i}</option>`;
            }
        };

        const getMonthlyReportData = async () => {
            const month = parseInt(document.getElementById('report-month').value);
            const year = parseInt(document.getElementById('report-year').value);

            const startDate = new Date(year, month, 1);
            const endDate = new Date(year, month + 1, 0, 23, 59, 59);

            const startTimestamp = Timestamp.fromDate(startDate);
            const endTimestamp = Timestamp.fromDate(endDate);

            let incomes = [];
            let expenses = [];
            let totalIncome = 0;
            let totalExpense = 0;
            
            // Use cached data for report generation
            allExpenses.forEach(expense => {
                if (expense.date >= startTimestamp && expense.date <= endTimestamp) {
                    expenses.push({ date: formatDate(expense.date), description: expense.description, amount: expense.amount });
                    totalExpense += expense.amount;
                }
            });

            [...allContributors, ...allZakatContributors].forEach(c => {
                c.donations?.forEach(d => {
                    if (d.date >= startTimestamp && d.date <= endTimestamp) {
                        const desc = `${c.name} থেকে ${c.donations ? 'অনুদান' : 'যাকাত'}`;
                        incomes.push({ date: formatDate(d.date), description: desc, amount: d.amount });
                        totalIncome += d.amount;
                    }
                });
            });

            allEvents.forEach(e => {
                e.donors?.forEach(ed => {
                    ed.donations?.forEach(d => {
                        if (d.date >= startTimestamp && d.date <= endTimestamp) {
                            incomes.push({ date: formatDate(d.date), description: `${e.name} ইভেন্টে ${ed.name} থেকে অনুদান`, amount: d.amount });
                            totalIncome += d.amount;
                        }
                    });
                });
            });

            return { incomes, expenses, totalIncome, totalExpense, month: document.getElementById('report-month').options[month].text, year };
        };

        const handleDownload = async (format) => {
            showToast('রিপোর্ট তৈরি করা হচ্ছে...');
            const reportData = await getMonthlyReportData();
            const fileName = `report-${reportData.month}-${reportData.year}.${format}`;
            
            if (format === 'txt') {
                let content = `হিলফুল ফুজুল যুব সংঘ বেগমপুর\n`;
                content += `মাসিক রিপোর্ট: ${reportData.month}, ${reportData.year}\n`;
                content += `=====================================\n\n`;
                
                content += `--- আয়ের হিসাব ---\n`;
                reportData.incomes.forEach(item => {
                    content += `${item.date} | ${item.description} | ${formatCurrency(item.amount)}\n`;
                });
                content += `\nমোট আয়: ${formatCurrency(reportData.totalIncome)}\n\n`;

                content += `--- ব্যয়ের হিসাব ---\n`;
                reportData.expenses.forEach(item => {
                    content += `${item.date} | ${item.description} | ${formatCurrency(item.amount)}\n`;
                });
                content += `\nমোট ব্যয়: ${formatCurrency(reportData.totalExpense)}\n\n`;

                content += `--- সারসংক্ষেপ ---\n`;
                content += `বর্তমান ব্যালেন্স: ${formatCurrency(reportData.totalIncome - reportData.totalExpense)}\n`;

                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                
                if (window.cordova) {
                    saveFileCordova(fileName, blob);
                } else {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    a.click();
                    URL.revokeObjectURL(url);
                }

            } else if (format === 'xlsx') {
                const incomeSheet = XLSX.utils.json_to_sheet(reportData.incomes.map(i => ({'তারিখ': i.date, 'বিবরণ': i.description, 'টাকা': i.amount})));
                const expenseSheet = XLSX.utils.json_to_sheet(reportData.expenses.map(e => ({'তারিখ': e.date, 'বিবরণ': e.description, 'টাকা': e.amount})));
                const summarySheet = XLSX.utils.json_to_sheet([
                    { 'বিবরণ': 'মোট আয়', 'টাকা': reportData.totalIncome },
                    { 'বিবরণ': 'মোট ব্যয়', 'টাকা': reportData.totalExpense },
                    { 'বিবরণ': 'বর্তমান ব্যালেন্স', 'টাকা': reportData.totalIncome - reportData.totalExpense },
                ]);

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, incomeSheet, "আয়");
                XLSX.utils.book_append_sheet(wb, expenseSheet, "ব্যয়");
                XLSX.utils.book_append_sheet(wb, summarySheet, "সারসংক্ষেপ");

                const wbout = XLSX.write(wb, { bookType:'xlsx', type:'array' });
                const blob = new Blob([wbout], {type:"application/octet-stream"});

                if (window.cordova) {
                    saveFileCordova(fileName, blob);
                } else {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    a.click();
                    URL.revokeObjectURL(url);
                }
            }
            if(!window.cordova) showToast('রিপোর্ট ডাউনলোড হয়েছে!', false);
        };
        
        const exportAllData = () => {
            showToast('ডেটা এক্সপোর্ট করা হচ্ছে...');
            const backup = {
                contributors: loadFromLocalStorage('contributors') || [],
                zakat_contributors: loadFromLocalStorage('zakat_contributors') || [],
                donors: loadFromLocalStorage('donors') || [],
                expenses: loadFromLocalStorage('expenses') || [],
                events: loadFromLocalStorage('events') || [],
                coordinators: loadFromLocalStorage('coordinators') || [],
                settings: loadFromLocalStorage('settings') || {},
            };
            
            const jsonString = JSON.stringify(backup, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const fileName = `hilful-fuzul-backup-${new Date().toISOString().split('T')[0]}.json`;

            if (window.cordova) {
                saveFileCordova(fileName, blob);
            } else {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                a.click();
                URL.revokeObjectURL(url);
                showToast('ডেটা এক্সপোর্ট সম্পন্ন হয়েছে!', false);
            }
        };

        const handleImportFile = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = e.target.result;
                    // No need to parse timestamps here as they are already stored in the correct format by export
                    const data = JSON.parse(json);
                    showConfirmModal(
                        'ডেটা ইমপোর্ট নিশ্চিত করুন', 
                        'আপনি কি নিশ্চিতভাবে এই ডেটা ইমপোর্ট করতে চান? এই কাজটি আপনার বর্তমান সকল ডেটা মুছে ফেলবে এবং পুনরুদ্ধার করা যাবে না।',
                        () => importData(data)
                    );
                } catch (err) {
                    showToast('ফাইলটি সঠিক JSON ফরম্যাটে নেই।', true);
                    console.error("Import Error:", err);
                }
            };
            reader.readAsText(file);
             // Reset file input
            event.target.value = null;
        };

        const importData = async (data) => {
            showToast('ডেটা ইমপোর্ট শুরু হয়েছে...');
            const batch = writeBatch(db);

            // Re-parse with timestamp reviver for Firestore
            const dataForFirestore = JSON.parse(JSON.stringify(data), (key, value) => {
                if (value && value._type === 'timestamp') {
                    return Timestamp.fromDate(new Date(value.value));
                }
                return value;
            });

            for (const colName in dataForFirestore) {
                if (Object.hasOwnProperty.call(dataForFirestore, colName)) {
                    const collectionData = dataForFirestore[colName];
                    for (const docId in collectionData) {
                        if (Object.hasOwnProperty.call(collectionData, docId)) {
                            const docData = { ...collectionData[docId] };
                            const docRef = doc(db, colName, docId);
                            
                            const subcollections = {};
                            if (docData.donations) {
                                subcollections.donations = docData.donations;
                                delete docData.donations;
                            }
                             if (docData.donors) {
                                subcollections.donors = docData.donors;
                                delete docData.donors;
                            }
                            if (docData.details) {
                                subcollections.details = docData.details;
                                delete docData.details;
                            }

                            batch.set(docRef, docData);

                            for(const subColName in subcollections) {
                                const subColData = subcollections[subColName];
                                for(const subDocId in subColData) {
                                    const subDocData = {...subColData[subDocId]};
                                    const subDocRef = doc(db, `${colName}/${docId}/${subColName}`, subDocId);

                                    if(subDocData.donations) {
                                        const level3Data = subDocData.donations;
                                        delete subDocData.donations;
                                        for(const l3DocId in level3Data) {
                                            const l3DocRef = doc(db, `${colName}/${docId}/${subColName}/${subDocId}/donations`, l3DocId);
                                            batch.set(l3DocRef, level3Data[l3DocId]);
                                        }
                                    }
                                    
                                    batch.set(subDocRef, subDocData);
                                }
                            }
                        }
                    }
                }
            }

            try {
                await batch.commit();
                showToast('ডেটা সফলভাবে ইমপোর্ট হয়েছে!', false);
                setTimeout(() => location.reload(), 1000);
            } catch (error) {
                showToast('ডেটা ইমপোর্ট করতে সমস্যা হয়েছে।', true);
                console.error("Batch Commit Error:", error);
            }
        };

        
        // --- CORDOVA SPECIFIC FEATURES ---
        const onDeviceReady = () => {
    document.addEventListener('backbutton', (e) => {
        e.preventDefault();
        
        // If a modal is open, close it
        if (document.querySelector('.modal-backdrop')) {
            closeModal();
            return;
        }

        // If on event details page, go back
        const eventDetailsView = document.getElementById('event-details-view');
        if (eventDetailsView && !eventDetailsView.classList.contains('hidden')) {
            document.getElementById('back-to-events-btn').click();
            return;
        }

        // If not on dashboard, switch to dashboard
        const dashboardPage = document.getElementById('dashboard-page');
        if (dashboardPage && !dashboardPage.classList.contains('hidden')) {
            showConfirmModal(
                'অ্যাপ থেকে বের হোন',
                'আপনি কি অ্যাপ থেকে বের হতে চান?',
                () => {
                    if (navigator.app) {
                        navigator.app.exitApp();
                    }
                }
            );
        } else {
            document.querySelector('[data-tab="dashboard"]').click();
        }
    }, false);
};

        // --- PULL TO REFRESH LOGIC ---
        const initPullToRefresh = () => {
    const mainContent = document.querySelector('main');
    const ptr = document.getElementById('pull-to-refresh');
    const ptrIcon = ptr.querySelector('.icon');
    
    let startY = 0;
    let diffY = 0;
    let isPulling = false;
    const threshold = 70;

    // শুধুমাত্র যখন সম্পূর্ণ উপরে থাকবে তখনই পুল টু রিফ্রেশ এক্টিভ হবে
    const isScrolledToTop = () => {
        return mainContent.scrollTop === 0;
    };

    const resetPtr = () => {
        ptr.style.transition = 'transform 0.3s';
        ptr.style.transform = 'translateY(0)';
        ptr.classList.remove('refreshing', 'ready');
        ptrIcon.style.transform = 'rotate(0deg)';
        ptrIcon.innerHTML = `<i data-lucide="arrow-down"></i>`;
        lucide.createIcons();
        
        setTimeout(() => {
            ptr.style.transition = '';
        }, 300);
    };

    mainContent.addEventListener('touchstart', (e) => {
        // শুধুমাত্র যখন সম্পূর্ণ উপরে থাকবে তখনই টাচ শুরু করবে
        if (isScrolledToTop()) {
            startY = e.touches[0].pageY;
            isPulling = true;
            ptr.style.transition = '';
        } else {
            isPulling = false;
        }
    }, { passive: true });

    mainContent.addEventListener('touchmove', (e) => {
        if (!isPulling) return;

        const currentY = e.touches[0].pageY;
        diffY = currentY - startY;

        // শুধুমাত্র নিচের দিকে স্ক্রল করলে কাজ করবে
        if (diffY > 0) {
            e.preventDefault();
            
            // পুল টু রিফ্রESH ইন্ডিকেটর আপডেট
            ptr.style.transform = `translateY(${Math.min(diffY, 100)}px)`;
            ptrIcon.style.transform = `rotate(${Math.min(diffY * 2, 180)}deg)`;
            
            if (diffY > threshold && !ptr.classList.contains('ready')) {
                ptr.classList.add('ready');
                ptrIcon.innerHTML = `<i data-lucide="arrow-up"></i>`;
                lucide.createIcons();
            } else if (diffY <= threshold && ptr.classList.contains('ready')) {
                ptr.classList.remove('ready');
                ptrIcon.innerHTML = `<i data-lucide="arrow-down"></i>`;
                lucide.createIcons();
            }
        } else {
            // উপরের দিকে স্ক্রল করলে পুল টু রিফ্রESH বাতিল
            isPulling = false;
            resetPtr();
        }
    }, { passive: false });

    mainContent.addEventListener('touchend', () => {
        if (!isPulling) return;
        
        isPulling = false;
        
        if (diffY > threshold) {
            showToast('ডেটা রিফ্রেশ হচ্ছে...');
            ptr.classList.add('refreshing');
            ptr.style.transition = 'transform 0.3s';
            ptr.style.transform = 'translateY(50px)';
            ptrIcon.style.transform = 'rotate(0deg)';
            ptrIcon.innerHTML = `<i data-lucide="loader-circle"></i>`;
            lucide.createIcons();

            // Clear cache and reload data
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith(LS_PREFIX)) {
                    localStorage.removeItem(key);
                }
            });
            
            // Reload all data
            loadAllData(true);

            setTimeout(() => {
                resetPtr();
                showToast('ডেটা সফলভাবে রিফ্রেশ হয়েছে!', false);
            }, 1500);

        } else {
            resetPtr();
        }

        diffY = 0;
    });

    // স্ক্রল ইভেন্ট লিসেনার যোগ করুন - স্ক্রল করলে পুল টু রিফ্রESH রিসেট হবে
    mainContent.addEventListener('scroll', () => {
        if (!isScrolledToTop() && isPulling) {
            isPulling = false;
            resetPtr();
        }
    });
};
    // সুপার অ্যাডমিন তৈরি করার ফাংশন
const createSuperAdmin = async (email, password) => {
    try {
        // Firebase Authentication এ ইউজার তৈরি করুন
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        // Firestore-এ ইউজার ডাটা সেভ করুন
        await setDoc(doc(db, "users", user.uid), {
            email: email,
            role: 'superadmin',
            createdAt: Timestamp.now()
        });
        
        console.log('সুপার অ্যাডমিন সফলভাবে তৈরি হয়েছে!');
        return user;
    } catch (error) {
        console.error('সুপার অ্যাডমিন তৈরি করতে সমস্যা:', error);
        throw error;
    }
};

// রেটিং ডিলেট ফাংশন
const deleteRating = (donorId, ratingId) => {
    showConfirmModal('নিশ্চিতকরণ', 'আপনি কি এই রেটিংটি মুছে ফেলতে চান?', async () => {
        try {
            await deleteDoc(doc(db, `donors/${donorId}/ratings`, ratingId));
            showToast('রেটিং মুছে ফেলা হয়েছে।');
            // রেটিং লিস্ট রিফ্রেশ করুন
            loadRatings(donorId);
        } catch (error) {
            showToast('রেটিং মুছতে সমস্যা হয়েছে।', true);
            console.error("Error deleting rating:", error);
        }
    });
};

 
        // --- INITIALIZE APP ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            initializeAppLogic();
            initPullToRefresh();
        });
        
        // This event fires when the Cordova device is ready
        document.addEventListener('deviceready', onDeviceReady, false);

    </script>
</body>
</html>
